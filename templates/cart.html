{% extends "base.html" %}

{% block content %}
<style>
    .shop-container { max-width: 1400px; margin: 2rem auto; padding: 0 1rem; display: grid; grid-template-columns: 250px 1fr; gap: 2rem; }
    @media (max-width: 992px) { .shop-container { grid-template-columns: 1fr; } }
    
    .sidebar { background: #f8f9fa; padding: 1.5rem; border-radius: 12px; border: 1px solid #eee; height: fit-content; position: sticky; top: 100px; }
    .category-link { display: block; padding: .6rem; text-decoration: none; color: #333; border-radius: 8px; transition: 0.2s; }
    .category-link:hover, .category-link.active { background: #e5edff; font-weight: bold; color: #2563eb; padding-left: 1rem; }
    
    .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.5rem; }
    .product-card { background: white; border: 1px solid #eee; border-radius: 16px; overflow: hidden; display: flex; flex-direction: column; transition: 0.3s; height: 100%; }
    .product-card:hover { transform: translateY(-5px); box-shadow: 0 12px 24px rgba(0,0,0,0.08); }
    
    .item-image { width: 100%; height: 200px; object-fit: contain; background: #f9f9f9; padding: 10px; }
    .card-details { padding: 1.25rem; display: flex; flex-direction: column; flex-grow: 1; }
    .price-tag { font-size: 1.3rem; font-weight: 800; color: #dc2626; margin-bottom: 1rem; }

    /* QTY CARD */
    .qty-card { border: 2px solid #edeff2; border-radius: 10px; display: flex; align-items: center; background: #fcfcfc; margin-bottom: 12px; justify-content: space-between; }
    .qty-btn { border: none; background: none; width: 45px; height: 40px; cursor: pointer; font-size: 1.2rem; font-weight: bold; color: #666; }
    .qty-btn:hover { background: #e5edff; color: #2563eb; }
    .qty-display { width: 50px; text-align: center; font-weight: 800; border: none; background: transparent; font-size: 1rem; }

    .cart-buttons { display: flex; gap: 0.6rem; }
    .btn-add-cart { background: white; border: 2px solid #2563eb; color: #2563eb; font-weight: 700; border-radius: 10px; }
    .btn-buy-now { background: #2563eb; border: 2px solid #2563eb; color: white; font-weight: 700; border-radius: 10px; }

    /* SMART PAGINATION */
    .pagination-wrapper { margin-top: 3rem; display: flex; flex-direction: column; align-items: center; }
    .pagination { background: white; padding: 5px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .page-link { color: #2563eb; font-weight: bold; border: none; margin: 0 2px; border-radius: 8px !important; }
    .page-item.active .page-link { background-color: #2563eb; color: white; }
    .page-item.disabled .page-link { color: #ccc; }

    /* ANIMATIONS */
    .flying-item { position: fixed; z-index: 9999; pointer-events: none; transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-size: 55px; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3)); }
    .delivery-car { position: fixed; z-index: 10000; font-size: 100px; pointer-events: none; left: -350px; bottom: 30%; transition: left 5s linear; display: flex; flex-direction: column; align-items: center; }
    .huat-bubble { background: #ffdf00; color: #000; padding: 12px 24px; border-radius: 30px; font-size: 20px; font-weight: 900; margin-bottom: 15px; opacity: 0; transition: opacity 0.5s; border: 3px solid #000; white-space: nowrap; }
    .van-body { transform: scaleX(-1); }
</style>

<div class="shop-container">
    <aside class="sidebar">
        <h5 class="font-weight-bold">üì¶ Categories</h5>
        <hr>
        <a href="{{ url_for('cart', search=search_query) }}" class="category-link {{ 'active' if not category_filter }}">All Products</a>
        {% for c in categories %}
        <a href="{{ url_for('cart', category=c['category'], search=search_query) }}" class="category-link {{ 'active' if category_filter == c['category'] }}">
            {{ c['category'] }}
        </a>
        {% endfor %}
        
        <div class="mt-5">
            <button onclick="localStorage.removeItem('cart'); location.reload();" class="btn btn-sm btn-outline-secondary border-0" style="font-size: 10px;">Reset Cart Data</button>
        </div>
    </aside>

    <main>
        <form action="{{ url_for('cart') }}" method="GET" class="mb-4 d-flex gap-2">
            <input type="text" name="search" class="form-control form-control-lg" placeholder="Search by name or part number..." value="{{ search_query }}">
            {% if category_filter %}
                <input type="hidden" name="category" value="{{ category_filter }}">
            {% endif %}
            <button type="submit" class="btn btn-primary px-4">üîç Search</button>
        </form>

        <div class="product-grid">
            {% for product in products %}
            <div class="product-card">
                <img src="{{ product['image_url'] or 'https://via.placeholder.com/300x200?text=Parts' }}" class="item-image">
                <div class="card-details">
                    <small class="text-muted text-uppercase fw-bold">{{ product['category'] }}</small>
                    <h6 class="mt-1 font-weight-bold" style="min-height: 40px;">{{ product['hem_name'] }}</h6>
                    
                    <div class="mt-auto">
                        <div class="price-tag">SGD {{ "%.2f"|format(product['sell_price']) }}</div>
                        
                        <div class="qty-card">
                            <button class="qty-btn" onclick="adjustShopQty('{{ product['inventory_id'] }}', -1)">‚àí</button>
                            <input type="number" id="qty-shop-{{ product['inventory_id'] }}" class="qty-display" value="1" readonly>
                            <button class="qty-btn" onclick="adjustShopQty('{{ product['inventory_id'] }}', 1)">+</button>
                        </div>
                        
                        <div class="cart-buttons">
                            <button onclick="handleAddToCart(event, {{ product['inventory_id'] }}, '{{ product['hem_name']|escape }}', {{ product['sell_price'] }}, false)" class="btn btn-add-cart btn-sm flex-fill">Add to Cart</button>
                            <button onclick="handleAddToCart(event, {{ product['inventory_id'] }}, '{{ product['hem_name']|escape }}', {{ product['sell_price'] }}, true)" class="btn btn-buy-now btn-sm flex-fill">Buy Now</button>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center py-5 w-100">
                <h3 class="text-muted">No items found matching your search. üò≠</h3>
            </div>
            {% endfor %}
        </div>

        {% if total_pages > 1 %}
        <nav class="pagination-wrapper">
            <ul class="pagination">
                <li class="page-item {{ 'disabled' if current_page == 1 }}">
                    <a class="page-link" href="{{ url_for('cart', page=current_page-1, category=category_filter, search=search_query) }}">¬´</a>
                </li>

                <li class="page-item {{ 'active' if current_page == 1 }}">
                    <a class="page-link" href="{{ url_for('cart', page=1, category=category_filter, search=search_query) }}">1</a>
                </li>

                {% if current_page > 4 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}

                {% for p in range(1, total_pages + 1) %}
                    {% if p > 1 and p < total_pages %}
                        {% if p >= current_page - 2 and p <= current_page + 2 %}
                            <li class="page-item {{ 'active' if p == current_page }}">
                                <a class="page-link" href="{{ url_for('cart', page=p, category=category_filter, search=search_query) }}">{{ p }}</a>
                            </li>
                        {% endif %}
                    {% endif %}
                {% endfor %}

                {% if current_page < total_pages - 3 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}

                <li class="page-item {{ 'active' if current_page == total_pages }}">
                    <a class="page-link" href="{{ url_for('cart', page=total_pages, category=category_filter, search=search_query) }}">{{ total_pages }}</a>
                </li>

                <li class="page-item {{ 'disabled' if current_page == total_pages }}">
                    <a class="page-link" href="{{ url_for('cart', page=current_page+1, category=category_filter, search=search_query) }}">¬ª</a>
                </li>
            </ul>
            <div class="mt-2 text-muted">
                <small>Page {{ current_page }} of {{ total_pages }} | 25,119 Items Total</small>
            </div>
        </nav>
        {% endif %}
    </main>
</div>

<script>
function adjustShopQty(id, delta) {
    const el = document.getElementById(`qty-shop-${id}`);
    let val = parseInt(el.value) + delta;
    el.value = val < 1 ? 1 : val;
}

function handleAddToCart(event, id, name, price, isBuyNow) {
    event.preventDefault();
    const qtyInput = document.getElementById(`qty-shop-${id}`);
    const qty = parseInt(qtyInput.value);
    const card = event.target.closest('.product-card');
    const imageUrl = card.querySelector('.item-image').src;
    
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const existing = cart.find(item => item.id === id);
    if (existing) existing.quantity += qty;
    else cart.push({ id, name, price: parseFloat(price), quantity: qty, image: imageUrl });
    
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartBadge();

    if (isBuyNow) startCarAnimation();
    else animateToCart(event);
}

function animateToCart(e) {
    const cartIcon = document.querySelector('.cart-badge');
    if(!cartIcon) return;
    const flyer = document.createElement('div');
    flyer.className = 'flying-item'; flyer.innerHTML = 'üì¶';
    document.body.appendChild(flyer);
    const startRect = e.target.getBoundingClientRect();
    const endRect = cartIcon.getBoundingClientRect();
    flyer.style.left = startRect.left + 'px';
    flyer.style.top = (startRect.top + window.scrollY) + 'px';
    requestAnimationFrame(() => {
        flyer.style.left = endRect.left + 'px';
        flyer.style.top = (endRect.top + window.scrollY) + 'px';
        flyer.style.transform = 'scale(0.2) rotate(360deg)';
        flyer.style.opacity = '0';
    });
    setTimeout(() => flyer.remove(), 800);
}

function startCarAnimation() {
    document.querySelectorAll('button').forEach(b => b.disabled = true);
    const carWrap = document.createElement('div');
    carWrap.className = 'delivery-car';
    carWrap.innerHTML = `<div class="huat-bubble" id="status-msg">Packing...</div><div class="van-body">üöêüí®</div>`;
    document.body.appendChild(carWrap);
    const bubble = carWrap.querySelector('#status-msg');
    setTimeout(() => { carWrap.style.left = '40%'; bubble.style.opacity = '1'; }, 100);
    setTimeout(() => { bubble.innerText = "Secured! Driving to Checkout..."; }, 2500);
    setTimeout(() => { carWrap.style.left = '120%'; }, 4500);
    setTimeout(() => { window.location.href = "{{ url_for('checkout') }}"; }, 5500);
}

function updateCartBadge() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const total = cart.reduce((sum, item) => sum + item.quantity, 0);
    const badge = document.querySelector('.cart-badge');
    if (badge) { badge.textContent = total; badge.style.display = total > 0 ? 'inline-block' : 'none'; }
}
document.addEventListener('DOMContentLoaded', updateCartBadge);
</script>
{% endblock %}
