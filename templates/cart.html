{% extends "base.html" %}

{% block content %}
<style>
    .shop-container { max-width: 1400px; margin: 2rem auto; padding: 0 1rem; display: grid; grid-template-columns: 250px 1fr; gap: 2rem; }
    @media (max-width: 992px) { .shop-container { grid-template-columns: 1fr; } }
    .sidebar { background: #f8f9fa; padding: 1.5rem; border-radius: 12px; border: 1px solid #eee; height: fit-content; }
    .category-link { display: block; padding: .5rem; text-decoration: none; color: #333; border-radius: 6px; }
    .category-link:hover, .category-link.active { background: #e5edff; font-weight: bold; color: #2563eb; }
    .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }
    .product-card { background: white; border: 1px solid #eee; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; transition: .2s; height: 100%; }
    .product-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0, 0, 0, .08); }
    .item-image { width: 100%; height: 200px; object-fit: contain; background: #f4f4f4; }
    .card-details { padding: 1rem; display: flex; flex-direction: column; flex-grow: 1; }
    .part-number { font-family: monospace; background: #f1f1f1; padding: 2px 6px; border-radius: 4px; font-size: .8rem; }
    .price-tag { font-size: 1.2rem; font-weight: 800; color: #dc2626; }
    .pagination-box { display: flex; justify-content: center; gap: 1rem; margin-top: 3rem; align-items: center; }
    .btn-page { padding: .5rem 1rem; border: 1px solid #2563eb; color: #2563eb; border-radius: 6px; text-decoration: none; }
    .btn-page:hover { background: #2563eb; color: white; }
    .btn-page.disabled { opacity: .4; pointer-events: none; border-color: #ccc; color: #999; }
    
    /* Cart buttons */
    .cart-buttons { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .btn-add-cart { background: white; border: 2px solid #2563eb; color: #2563eb; font-weight: 600; }
    .btn-add-cart:hover { background: #eff6ff; }
    .btn-buy-now { background: #2563eb; border: 2px solid #2563eb; color: white; font-weight: 600; }
    .btn-buy-now:hover { background: #1d4ed8; }
    
    /* Quantity selector */
    .qty-selector { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
    .qty-btn { width: 30px; height: 30px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; }
    .qty-btn:hover { background: #f3f4f6; }
    .qty-input { width: 50px; text-align: center; border: 1px solid #ddd; border-radius: 4px; padding: 4px; }
</style>

<div class="shop-container">
    <aside class="sidebar">
        <h5>ðŸ“¦ Categories</h5>
        <hr>
        <a href="{{ url_for('cart') }}" class="category-link {{ 'active' if not category_filter }}">All Products</a>
        {% for c in categories %}
        <a href="{{ url_for('cart', category=c.category, search=search_query) }}"
            class="category-link {{ 'active' if category_filter == c.category }}">
            {{ c.category }}
        </a>
        {% endfor %}
    </aside>

    <main>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>ðŸ›’ Component Shop</h2>
            <span class="text-muted">Page {{ current_page }} of {{ total_pages }}</span>
        </div>

        <form method="GET" class="d-flex gap-2 mb-4">
            <input class="form-control" type="text" name="search" placeholder="Search name/part no" value="{{ search_query }}">
            <input type="hidden" name="category" value="{{ category_filter }}">
            <button class="btn btn-primary px-4">Search</button>
        </form>

        <div class="product-grid">
            {% for product in products %}
            <div class="product-card">
                <img src="{{ product.image_url or 'https://via.placeholder.com/300x200/f4f4f4/999999?text=No+Image' }}" 
                     class="item-image" 
                     alt="{{ product.hem_name }}"
                     onerror="this.src='https://via.placeholder.com/300x200/f4f4f4/999999?text=No+Image';">

                <div class="card-details">
                    <small class="text-muted text-uppercase fw-bold">{{ product.category }}</small>
                    <h6 class="mt-1">{{ product.hem_name }}</h6>
                    <p class="mb-1 small">Part No: <span class="part-number">{{ product.sup_part_no }}</span></p>

                    <div class="mt-auto">
                        <div class="price-tag mb-2">SGD {{ "%.2f"|format(product.sell_price) }}</div>
                        
                        <!-- Quantity Selector -->
                        <div class="qty-selector">
                            <button type="button" class="qty-btn" onclick="changeQty({{ product.inventory_id }}, -1)">âˆ’</button>
                            <input type="number" id="qty-{{ product.inventory_id }}" class="qty-input" value="1" min="1" max="99" readonly>
                            <button type="button" class="qty-btn" onclick="changeQty({{ product.inventory_id }}, 1)">+</button>
                        </div>
                        
                        <!-- Cart Buttons -->
                        <div class="cart-buttons">
                            <button onclick="addToCart({{ product.inventory_id }}, '{{ product.hem_name }}', {{ product.sell_price }})" 
                                    class="btn btn-add-cart btn-sm flex-fill">
                                Add to Cart
                            </button>
                            <button onclick="buyNow({{ product.inventory_id }}, '{{ product.hem_name }}', {{ product.sell_price }})" 
                                    class="btn btn-buy-now btn-sm flex-fill">
                                Buy Now
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center w-100 py-5"><h4>No products found</h4></div>
            {% endfor %}
        </div>

        {% if total_pages > 1 %}
        <div class="pagination-box">
            <a class="btn-page {{ 'disabled' if current_page == 1 }}"
                href="{{ url_for('cart', page=current_page-1, search=search_query, category=category_filter) }}">Â« Prev</a>
            <span><strong>{{ current_page }}</strong> / {{ total_pages }}</span>
            <a class="btn-page {{ 'disabled' if current_page == total_pages }}"
                href="{{ url_for('cart', page=current_page+1, search=search_query, category=category_filter) }}">Next Â»</a>
        </div>
        {% endif %}
    </main>
</div>

<script>
// Cart functionality using sessionStorage
function getCart() {
    return JSON.parse(sessionStorage.getItem('cart') || '[]');
}

function saveCart(cart) {
    sessionStorage.setItem('cart', JSON.stringify(cart));
    updateCartBadge();
}

function updateCartBadge() {
    const cart = getCart();
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    
    // Update cart badge in navbar (you'll need to add this to base.html)
    const badge = document.querySelector('.cart-badge');
    if (badge) {
        badge.textContent = totalItems;
        badge.style.display = totalItems > 0 ? 'inline-block' : 'none';
    }
}

function changeQty(productId, delta) {
    const input = document.getElementById(`qty-${productId}`);
    let value = parseInt(input.value) + delta;
    value = Math.max(1, Math.min(99, value));
    input.value = value;
}

function addToCart(productId, productName, price) {
    const quantity = parseInt(document.getElementById(`qty-${productId}`).value);
    const cart = getCart();
    
    // Check if product already in cart
    const existing = cart.find(item => item.id === productId);
    
    if (existing) {
        existing.quantity += quantity;
    } else {
        cart.push({
            id: productId,
            name: productName,
            price: price,
            quantity: quantity
        });
    }
    
    saveCart(cart);
    
    // Show success message
    alert(`âœ… Added ${quantity}x ${productName} to cart!`);
}

function buyNow(productId, productName, price) {
    const quantity = parseInt(document.getElementById(`qty-${productId}`).value);
    const cart = getCart();
    
    // Check if product already in cart
    const existing = cart.find(item => item.id === productId);
    
    if (existing) {
        existing.quantity += quantity;
    } else {
        cart.push({
            id: productId,
            name: productName,
            price: price,
            quantity: quantity
        });
    }
    
    saveCart(cart);
    
    // Redirect to checkout
    window.location.href = "{{ url_for('checkout') }}";
}

// Initialize cart badge on page load
document.addEventListener('DOMContentLoaded', updateCartBadge);
</script>
{% endblock %}