{% extends "base.html" %}

{% block content %}
<style>
    .shop-container { max-width: 1400px; margin: 2rem auto; padding: 0 1rem; display: grid; grid-template-columns: 250px 1fr; gap: 2rem; }
    @media (max-width: 992px) { .shop-container { grid-template-columns: 1fr; } }
    .sidebar { background: #f8f9fa; padding: 1.5rem; border-radius: 12px; border: 1px solid #eee; height: fit-content; }
    .category-link { display: block; padding: .5rem; text-decoration: none; color: #333; border-radius: 6px; }
    .category-link:hover, .category-link.active { background: #e5edff; font-weight: bold; color: #2563eb; }
    
    .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }
    .product-card { background: white; border: 1px solid #eee; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; transition: .2s; height: 100%; }
    .item-image { width: 100%; height: 200px; object-fit: contain; background: #f4f4f4; }
    .card-details { padding: 1rem; display: flex; flex-direction: column; flex-grow: 1; }
    .price-tag { font-size: 1.2rem; font-weight: 800; color: #dc2626; }

    /* QTY CARD */
    .qty-card { border: 2px solid #edeff2; border-radius: 8px; display: flex; align-items: center; background: #fcfcfc; margin-bottom: 10px; }
    .qty-btn { border: none; background: none; width: 40px; height: 40px; cursor: pointer; font-size: 1.2rem; }
    .qty-btn:hover { background: #e5edff; color: #2563eb; }
    .qty-display { width: 50px; text-align: center; font-weight: 800; border: none; background: transparent; }

    .cart-buttons { display: flex; gap: 0.5rem; }
    .btn-add-cart { background: white; border: 2px solid #2563eb; color: #2563eb; font-weight: 600; border-radius: 8px; }
    .btn-buy-now { background: #2563eb; border: 2px solid #2563eb; color: white; font-weight: 600; border-radius: 8px; }

    /* ANIMATIONS */
    .flying-item { position: fixed; z-index: 9999; pointer-events: none; transition: all 0.8s cubic-bezier(0.25, 0.1, 0.25, 1); font-size: 55px; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.2)); }
    .delivery-car { position: fixed; z-index: 10000; font-size: 90px; pointer-events: none; left: -300px; bottom: 30%; transition: left 5s linear, transform 0.5s ease; display: flex; flex-direction: column; align-items: center; }
    .huat-bubble { background: #ffdf00; color: #000; padding: 10px 20px; border-radius: 25px; font-size: 18px; font-weight: 800; margin-bottom: 15px; opacity: 0; transition: opacity 0.5s; border: 2px solid #000; white-space: nowrap; }
    .van-body { transform: scaleX(-1); }
</style>

<div class="shop-container">
    <aside class="sidebar">
        <h5>üì¶ Categories</h5>
        <hr>
        <a href="{{ url_for('cart') }}" class="category-link {{ 'active' if not category_filter }}">All Products</a>
        {% for c in categories %}
        <a href="{{ url_for('cart', category=c.category) }}" class="category-link {{ 'active' if category_filter == c.category }}">{{ c.category }}</a>
        {% endfor %}
    </aside>

    <main>
        <div class="product-grid">
            {% for product in products %}
            <div class="product-card">
                <img src="{{ product.image_url or 'https://via.placeholder.com/300x200' }}" class="item-image">
                <div class="card-details">
                    <small class="text-muted text-uppercase fw-bold">{{ product.category }}</small>
                    <h6 class="mt-1 font-weight-bold">{{ product.hem_name }}</h6>
                    <div class="mt-auto">
                        <div class="price-tag mb-2">SGD {{ "%.2f"|format(product.sell_price) }}</div>
                        <div class="qty-card">
                            <button class="qty-btn" onclick="adjustShopQty('{{ product.inventory_id }}', -1)">‚àí</button>
                            <input type="number" id="qty-shop-{{ product.inventory_id }}" class="qty-display" value="1" readonly>
                            <button class="qty-btn" onclick="adjustShopQty('{{ product.inventory_id }}', 1)">+</button>
                        </div>
                        <div class="cart-buttons">
                            <button onclick="handleAddToCart(event, {{ product.inventory_id }}, '{{ product.hem_name|escape }}', {{ product.sell_price }}, false)" class="btn btn-add-cart btn-sm flex-fill">Add to Cart</button>
                            <button onclick="handleAddToCart(event, {{ product.inventory_id }}, '{{ product.hem_name|escape }}', {{ product.sell_price }}, true)" class="btn btn-buy-now btn-sm flex-fill">Buy Now</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </main>
</div>

<script>
function adjustShopQty(id, delta) {
    const el = document.getElementById(`qty-shop-${id}`);
    let val = parseInt(el.value) + delta;
    el.value = val < 1 ? 1 : val;
}

function handleAddToCart(event, id, name, price, isBuyNow) {
    event.preventDefault();
    event.stopPropagation();
    const qty = parseInt(document.getElementById(`qty-shop-${id}`).value);
    const card = event.target.closest('.product-card');
    const imageUrl = card.querySelector('.item-image').src;
    
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const existing = cart.find(item => item.id === id);
    if (existing) {
        existing.quantity += qty;
    } else {
        cart.push({ id, name, price: parseFloat(price), quantity: qty, image: imageUrl });
    }
    
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCartBadge();

    if (isBuyNow) startCarAnimation();
    else animateToCart(event);
}

function animateToCart(e) {
    const cartIcon = document.querySelector('.cart-badge');
    const flyer = document.createElement('div');
    flyer.className = 'flying-item'; flyer.innerHTML = 'üì¶';
    document.body.appendChild(flyer);
    const startRect = e.target.getBoundingClientRect();
    const endRect = cartIcon.getBoundingClientRect();
    flyer.style.left = startRect.left + 'px';
    flyer.style.top = (startRect.top + window.scrollY) + 'px';
    requestAnimationFrame(() => {
        flyer.style.left = endRect.left + 'px';
        flyer.style.top = (endRect.top + window.scrollY) + 'px';
        flyer.style.transform = 'scale(0.2) rotate(360deg)';
        flyer.style.opacity = '0';
    });
    setTimeout(() => flyer.remove(), 800);
}

function startCarAnimation() {
    document.querySelectorAll('button').forEach(b => b.disabled = true);
    const carWrap = document.createElement('div');
    carWrap.className = 'delivery-car';
    carWrap.innerHTML = `<div class="huat-bubble" id="status-msg">Packing...</div><div class="van-body">üöêüí®</div>`;
    document.body.appendChild(carWrap);
    const bubble = carWrap.querySelector('#status-msg');
    setTimeout(() => { carWrap.style.left = '40%'; bubble.style.opacity = '1'; }, 100);
    setTimeout(() => { bubble.innerText = "Secured! Driving to Checkout..."; }, 2500);
    setTimeout(() => { carWrap.style.left = '120%'; }, 4500);
    setTimeout(() => { window.location.href = "{{ url_for('checkout') }}"; }, 5500);
}

function updateCartBadge() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const total = cart.reduce((sum, item) => sum + item.quantity, 0);
    const badge = document.querySelector('.cart-badge');
    if (badge) { badge.textContent = total; badge.style.display = total > 0 ? 'inline-block' : 'none'; }
}
document.addEventListener('DOMContentLoaded', updateCartBadge);
</script>
{% endblock %}
