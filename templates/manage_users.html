from werkzeug.security import generate_password_hash
from flask import render_template, request, session
import sqlite3

@app.route("/manage-users", methods=["GET", "POST"])
@require_roles("superowner")
def manage_users():
    conn = sqlite3.connect(DB)
    c = conn.cursor()
    message = ""

    if request.method == "POST":
        action = request.form.get("action", "").strip()

        if action == "add":
            username = request.form.get("username", "").strip()
            password = request.form.get("password", "").strip()
            role = request.form.get("role", "").strip()

            try:
                hashed_password = generate_password_hash(password)
                c.execute(
                    "INSERT INTO users(username, password_hash, role, active) VALUES (?, ?, ?, 1)",
                    (username, hashed_password, role)
                )
                conn.commit()
                message = f"User '{username}' added as {role}."
            except sqlite3.IntegrityError:
                message = f"Error: Username '{username}' already exists."
            except Exception as e:
                message = f"Error: {e}"

        elif action == "toggle":
            username = request.form.get("username", "").strip()
            c.execute("SELECT active FROM users WHERE username=?", (username,))
            result = c.fetchone()
            if result:
                new_status = 0 if result[0] == 1 else 1
                c.execute("UPDATE users SET active=? WHERE username=?", (new_status, username))
                conn.commit()
                message = f"User '{username}' {'enabled' if new_status == 1 else 'disabled'}."
            else:
                message = f"User '{username}' not found."

        elif action == "delete":
            username = request.form.get("username", "").strip()
            if username == session.get("username"):
                message = "Error: Cannot delete your own account."
            else:
                c.execute("DELETE FROM users WHERE username=?", (username,))
                conn.commit()
                message = f"User '{username}' deleted."

        elif action == "change_role":
            username = request.form.get("username", "").strip()
            new_role = request.form.get("new_role", "").strip()
            c.execute("UPDATE users SET role=? WHERE username=?", (new_role, username))
            conn.commit()
            message = f"User '{username}' role changed to {new_role}."

    # Fetch all users to display
    c.execute("SELECT username, role, active FROM users ORDER BY role, username")
    users = c.fetchall()
    conn.close()

    return render_template("manage_users.html", users=users, message=message)
