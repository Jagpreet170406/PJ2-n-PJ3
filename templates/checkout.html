<!-- ============================================ -->
<!-- CHECKOUT PAGE - Order Confirmation & Payment -->
<!-- ============================================ -->

<!-- Template Setup: Extends base.html layout -->
{% extends "base.html" %}
{% block content %}

<!-- Main Container: Checkout page content with top margin to clear navbar -->
<div class="container mb-5" style="margin-top: 100px;">
    
    <!-- Page Title -->
    <h2 class="mb-4">Confirm Order</h2>
    
    <!-- Two-Column Layout: Left = Forms, Right = Bill Summary -->
    <div class="row">
        
        <!-- ============================================ -->
        <!-- LEFT COLUMN: Order Details & Payment Forms -->
        <!-- ============================================ -->
        <div class="col-md-8">

            <!-- ========== SECTION 1: REVIEW BASKET ========== -->
            <!-- Shows all items in cart with quantity adjusters -->
            <div class="card p-4 shadow-sm mb-4 border-0" style="border-left: 5px solid #2563eb !important; background: #fdfdfd;">
                <h5 class="font-weight-bold">1. Review Your Basket</h5>
                <hr>
                <!-- Cart items will be dynamically loaded here by JavaScript -->
                <div id="cart-items-container"></div>
            </div>

            <!-- ========== SECTION 2: FULFILLMENT METHOD ========== -->
            <!-- Choose between Self-Pickup or Delivery -->
            <div class="card p-4 shadow-sm mb-4">
                <h5 class="font-weight-bold">2. Fulfillment Method</h5>
                
                <!-- Two Selection Boxes: Pickup vs Delivery -->
                <div class="row mt-3">
                    
                    <!-- Self-Pickup Option (Default Active) -->
                    <div class="col-6">
                        <div class="p-3 border rounded text-center selection-box active" 
                             id="box-pickup" 
                             onclick="setFulfillment('pickup')">
                            <h3>üè™</h3>
                            <b>Self-Pickup</b>
                        </div>
                    </div>
                    
                    <!-- Local Delivery Option -->
                    <div class="col-6">
                        <div class="p-3 border rounded text-center selection-box" 
                             id="box-delivery" 
                             onclick="setFulfillment('delivery')">
                            <h3>üöö</h3>
                            <b>Local Delivery</b>
                        </div>
                    </div>
                </div>

                <!-- Pickup Date Selector (Shows when Pickup is selected) -->
                <div id="pickup-date-section" class="mt-3">
                    <label>üìÖ Pick-up Date</label>
                    <input type="date" id="pickup-date" class="form-control">
                </div>

                <!-- Delivery Address Input (Shows when Delivery is selected, hidden by default) -->
                <div id="delivery-address-section" class="mt-3 d-none">
                    <label>üìç Delivery Address</label>
                    <textarea id="delivery-address" 
                              class="form-control" 
                              placeholder="Block, Street, Unit No, Postal Code"></textarea>
                </div>
            </div>

            <!-- ========== SECTION 3: PAYMENT DETAILS ========== -->
            <!-- Credit card, PayNow, or PayLah payment options -->
            <div class="card p-4 shadow-sm mb-4" id="payment-card-section">
                <h5 class="font-weight-bold">3. Payment Details</h5>
                <hr>
                
                <!-- Payment Method Logo Display (Visa, Mastercard, PayNow, PayLah) -->
                <div class="text-center mb-3" style="height: 55px; display: flex; align-items: center; justify-content: center;">
                    <img id="card-logo" 
                         src="{{ url_for('static', filename='checkout/visa.png') }}" 
                         height="45" 
                         style="transition: all 0.3s ease; object-fit: contain; display:none;">
                </div>

                <!-- Payment Method Selector Dropdown -->
                <select class="form-control form-control-lg mb-4" 
                        id="payment-method" 
                        onchange="togglePaymentMethod()">
                    <option value="Credit Card">Credit / Debit Card</option>
                    <option value="PayNow">PayNow (QR Code)</option>
                    <option value="PayLah">DBS PayLah!</option>
                </select>

                <!-- Saved Cards Dropdown (Only shows for Credit Card option) -->
                <div id="saved-cards-wrapper" class="mb-3">
                    <label class="small font-weight-bold text-muted text-uppercase">Select a Saved Card</label>
                    <select class="form-control mb-3" 
                            id="saved-card-id" 
                            onchange="handleSavedCardChange()">
                        <!-- Default: Use new card -->
                        <option value="new">+ Use a new card</option>
                        <!-- Saved cards will be loaded here by JavaScript -->
                    </select>
                </div>

                <!-- Credit Card Input Fields (Shows when entering new card) -->
                <div id="card-details-section">
                    <!-- Cardholder Name -->
                    <input type="text" 
                           id="card-name" 
                           class="form-control mb-2" 
                           placeholder="NAME ON CARD">
                    
                    <!-- Card Number (Auto-detects Visa/Mastercard and formats with spaces) -->
                    <input type="tel" 
                           id="card-number" 
                           class="form-control mb-2" 
                           placeholder="CARD NUMBER" 
                           maxlength="19" 
                           oninput="detectCard(this.value)">
                    
                    <!-- Expiry Date and CVV Row -->
                    <div class="row">
                        <!-- Expiry Date (MM/YY format) -->
                        <div class="col-6">
                            <input type="tel" 
                                   id="card-exp" 
                                   class="form-control" 
                                   placeholder="MM/YY" 
                                   maxlength="5">
                        </div>
                        
                        <!-- CVV Security Code -->
                        <div class="col-6">
                            <input type="password" 
                                   id="card-cvv" 
                                   class="form-control" 
                                   placeholder="CVV" 
                                   maxlength="4">
                        </div>
                    </div>
                    
                    <!-- Save Card Checkbox (Saves card to browser localStorage) -->
                    <div class="custom-control custom-checkbox mt-3">
                        <input type="checkbox" 
                               class="custom-control-input" 
                               id="save-card-checkbox" 
                               checked>
                        <label class="custom-control-label text-primary font-weight-bold" 
                               for="save-card-checkbox" 
                               style="cursor:pointer;">
                            Save card securely in this browser for future orders
                        </label>
                    </div>
                </div>
                
                <!-- Error Message Display (Shows validation errors) -->
                <div id="card-error-msg" class="text-danger small mt-2 font-weight-bold"></div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- RIGHT COLUMN: BILL SUMMARY (Sticky Sidebar) -->
        <!-- ============================================ -->
        <div class="col-md-4">
            <!-- Sticky Bill Summary Card (Follows you when scrolling) -->
            <div class="card p-4 shadow-sm sticky-top border-primary" style="top: 110px; border-width: 2px;">
                
                <h4 class="font-weight-bold">Bill Summary</h4>
                
                <!-- ========== DELIVERY INCENTIVE BOX ========== -->
                <!-- Shows progress to free delivery (hidden by default) -->
                <div id="delivery-incentive-box" 
                     class="p-3 mb-3 rounded" 
                     style="display: none; background: #fffbeb; border: 1px solid #fcd34d;">
                    
                    <!-- Incentive Text and Amount Needed -->
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="font-weight-bold text-dark" id="incentive-text">Next Tier</small>
                        <small class="font-weight-bold" id="incentive-amount"></small>
                    </div>
                    
                    <!-- Progress Bar (Animated) -->
                    <div class="progress" style="height: 8px;">
                        <div id="incentive-bar" 
                             class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                             role="progressbar" 
                             style="width: 0%"></div>
                    </div>
                </div>

                <!-- ========== PRICE BREAKDOWN ========== -->
                
                <!-- Subtotal (Before shipping) -->
                <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal</span>
                    <span id="summary-subtotal">S$0.00</span>
                </div>
                
                <!-- Delivery Fee (Shows "FREE" or amount) -->
                <div class="d-flex justify-content-between mb-2">
                    <span>Delivery Fee</span>
                    <span id="summary-shipping">S$0.00</span>
                </div>
                
                <hr>
                
                <!-- Grand Total -->
                <div class="d-flex justify-content-between mb-4">
                    <span class="h4 font-weight-bold">Total</span>
                    <span class="h4 font-weight-bold text-primary" id="summary-total">S$0.00</span>
                </div>
                
                <!-- ========== PAYMENT BUTTON ========== -->
                <!-- Triggers payment processing -->
                <button id="btn-pay" 
                        class="btn btn-primary btn-block btn-lg py-3 font-weight-bold" 
                        onclick="processPayment()">
                    CONFIRM!
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- CSS STYLING -->
<!-- ============================================ -->
<style>
/* Selection Box: Pickup/Delivery option boxes with hover effect */
.selection-box { 
    cursor: pointer; 
    transition: 0.3s; 
    border: 2px solid #eee; 
    border-radius: 12px; 
}

/* Active Selection: Highlighted with blue border and light blue background */
.selection-box.active { 
    border-color: #2563eb; 
    background: #eff6ff; 
}

/* Quantity Card in Checkout: +/- buttons for adjusting item quantities */
.checkout-qty-card { 
    display: flex; 
    align-items: center; 
    border: 1px solid #ddd; 
    border-radius: 6px; 
    padding: 2px 5px; 
    background: #fff; 
}

/* Shake Animation: Used for error feedback on invalid card input */
@keyframes shake { 
    0% { transform: translateX(0); } 
    25% { transform: translateX(-5px); } 
    50% { transform: translateX(5px); } 
    75% { transform: translateX(-5px); } 
    100% { transform: translateX(0); } 
}

/* Shake Class: Applied to payment section when validation fails */
.shake { 
    animation: shake 0.4s ease-in-out; 
    border: 2px solid #dc3545 !important; /* Red border for error */
}
</style>

<!-- ============================================ -->
<!-- JAVASCRIPT SECTION -->
<!-- ============================================ -->
<script>

/* ========== GLOBAL VARIABLE ========== */
/* Tracks current fulfillment method (pickup or delivery) */
let currentFulfillment = 'pickup';

/* ========== LOAD SAVED CARDS FROM LOCALSTORAGE ========== */
/* Populates the saved cards dropdown with previously saved cards */
function loadSavedCards(){
    // Get saved cards from browser storage
    const savedCards = JSON.parse(localStorage.getItem('saved_cards') || '[]');
    const select = document.getElementById('saved-card-id');
    
    // Reset dropdown to default option
    select.innerHTML = '<option value="new">+ Use a new card</option>';
    
    // Add each saved card as an option
    savedCards.forEach(function(card, index){
        const option = document.createElement('option');
        option.value = index; // Index used to retrieve card later
        option.textContent = 'üí≥ ' + card.brand + ' ending in ' + card.last4 + ' (Exp: ' + card.exp + ')';
        select.appendChild(option);
    });
}

/* ========== SAVE CARD TO LOCALSTORAGE ========== */
/* Stores card details in browser for future use (NOT sent to server) */
function saveCardToLocalStorage(cardDetails){
    // Load existing saved cards
    const savedCards = JSON.parse(localStorage.getItem('saved_cards') || '[]');
    
    // Check if this card already exists (same last 4 digits and expiry)
    const exists = savedCards.some(function(card){
        return card.last4 === cardDetails.last4 && card.exp === cardDetails.exp;
    });
    
    // Only save if it's a new card
    if(!exists){
        savedCards.push({
            brand: cardDetails.brand,      // Visa or Mastercard
            last4: cardDetails.last4,      // Last 4 digits
            exp: cardDetails.exp,          // Expiry date (MM/YY)
            name: cardDetails.name         // Cardholder name
        });
        localStorage.setItem('saved_cards', JSON.stringify(savedCards));
        console.log('Card saved to browser!');
    } else {
        console.log('Card already saved');
    }
}

/* ========== LUHN ALGORITHM VALIDATION ========== */
/* Validates credit card number using industry-standard Luhn checksum */
/* Returns true if card number is mathematically valid */
function validateLuhn(number){
    let sum = 0;
    let isSecond = false;
    
    // Loop through digits from right to left
    for(let i = number.length - 1; i >= 0; i--){
        let d = parseInt(number.charAt(i));
        
        // Double every second digit
        if(isSecond){
            d *= 2;
            // If result is > 9, subtract 9
            if(d > 9) d -= 9;
        }
        
        sum += d;
        isSecond = !isSecond;
    }
    
    // Valid if sum is divisible by 10
    return (sum % 10) == 0;
}

/* ========== DETECT CARD TYPE AND FORMAT NUMBER ========== */
/* Auto-detects Visa/Mastercard and displays logo, formats number with spaces */
function detectCard(val){
    const logo = document.getElementById('card-logo');
    const input = document.getElementById('card-number');
    
    // Remove all non-digit characters
    const num = val.replace(/\D/g, '');
    
    // Format with spaces every 4 digits (e.g., "1234 5678 9012 3456")
    input.value = num.replace(/(\d{4})(?=\d)/g, '$1 ').trim();
    
    // Image paths for card logos
    const VISA = "{{ url_for('static', filename='checkout/visa.png') }}";
    const MC = "{{ url_for('static', filename='checkout/mastercard.png') }}";
    
    // Detect card brand by first digit
    if(num.startsWith('4')){ 
        // Visa cards start with 4
        logo.src = VISA; 
        logo.style.display = 'inline'; 
    }
    else if(num.startsWith('5')){ 
        // Mastercard starts with 5
        logo.src = MC; 
        logo.style.display = 'inline'; 
    }
    else{ 
        // Unknown card type
        logo.style.display = 'none'; 
    }
}

/* ========== DETECT CARD BRAND ========== */
/* Returns "Visa", "Mastercard", or "Unknown" based on first digit */
function detectCardBrand(num){
    if(num.startsWith('4')) return 'Visa';
    if(num.startsWith('5')) return 'Mastercard';
    return 'Unknown';
}

/* ========== HANDLE SAVED CARD SELECTION ========== */
/* When user selects a saved card, hide input fields and populate with saved data */
function handleSavedCardChange(){
    const val = document.getElementById('saved-card-id').value;
    const cardDetailsSection = document.getElementById('card-details-section');
    
    if(val === 'new'){
        // User wants to enter a new card
        cardDetailsSection.style.display = 'block';
        
        // Clear all input fields
        document.getElementById('card-name').value = '';
        document.getElementById('card-number').value = '';
        document.getElementById('card-exp').value = '';
        document.getElementById('card-cvv').value = '';
    } else {
        // User selected a saved card
        const savedCards = JSON.parse(localStorage.getItem('saved_cards') || '[]');
        const card = savedCards[parseInt(val)];
        
        if(card){
            // Populate fields with saved card data (masked number)
            document.getElementById('card-name').value = card.name || '';
            document.getElementById('card-number').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ' + card.last4;
            document.getElementById('card-exp').value = card.exp;
        }
        
        // Hide input section (card already selected)
        cardDetailsSection.style.display = 'none';
    }
}

/* ========== TOGGLE PAYMENT METHOD ========== */
/* Switches between Credit Card, PayNow, and PayLah displays */
function togglePaymentMethod(){
    const method = document.getElementById('payment-method').value;
    const logo = document.getElementById('card-logo');
    const cardSection = document.getElementById('card-details-section');
    const savedCardsWrapper = document.getElementById('saved-cards-wrapper');
    
    // Image paths for payment methods
    const PAYNOW = "{{ url_for('static', filename='checkout/paynow.jpg') }}";
    const PAYLAH = "{{ url_for('static', filename='checkout/paylah.png') }}";
    
    if(method === 'Credit Card'){
        // Show card input fields and saved cards dropdown
        cardSection.style.display = 'block';
        savedCardsWrapper.style.display = 'block';
        handleSavedCardChange(); // Load saved card if selected
    }
    else if(method === 'PayNow'){
        // Hide card inputs, show PayNow logo
        cardSection.style.display = 'none';
        savedCardsWrapper.style.display = 'none';
        logo.src = PAYNOW;
        logo.style.display = 'inline';
    }
    else if(method === 'PayLah'){
        // Hide card inputs, show PayLah logo
        cardSection.style.display = 'none';
        savedCardsWrapper.style.display = 'none';
        logo.src = PAYLAH;
        logo.style.display = 'inline';
    }
}

/* ========== SET FULFILLMENT METHOD ========== */
/* Switches between Pickup and Delivery options */
function setFulfillment(method){
    currentFulfillment = method;
    
    // Toggle active class on selection boxes
    document.getElementById('box-pickup').classList.toggle('active', method === 'pickup');
    document.getElementById('box-delivery').classList.toggle('active', method === 'delivery');
    
    // Show/hide appropriate date/address sections
    document.getElementById('delivery-address-section').classList.toggle('d-none', method === 'pickup');
    document.getElementById('pickup-date-section').classList.toggle('d-none', method === 'delivery');
    
    // Recalculate totals (delivery affects shipping cost)
    loadCheckoutCart();
}

/* ========== LOAD CART ITEMS INTO CHECKOUT ========== */
/* Displays all cart items with quantity controls and calculates totals */
function loadCheckoutCart(){
    // Load cart from localStorage
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const container = document.getElementById('cart-items-container');
    let subtotal = 0;
    
    // Build HTML for each cart item
    container.innerHTML = cart.map(function(item, i){
        subtotal += item.price * item.quantity;
        
        return '<div class="d-flex align-items-center mb-3 pb-3 border-bottom">' +
            // Product Image
            '<img src="' + item.image + '" style="width:50px;height:50px;object-fit:contain;margin-right:15px;">' +
            
            // Product Name and Price
            '<div class="flex-grow-1">' +
                '<b>' + item.name + '</b><br>' +
                '<small>S$' + item.price.toFixed(2) + '</small>' +
            '</div>' +
            
            // Quantity Adjuster (+/- buttons)
            '<div class="checkout-qty-card mx-2">' +
                '<button class="btn btn-sm" onclick="updateQty(' + i + ',-1)">‚àí</button>' +
                '<span class="px-2">' + item.quantity + '</span>' +
                '<button class="btn btn-sm" onclick="updateQty(' + i + ',1)">+</button>' +
            '</div>' +
            
            // Item Total (price √ó quantity)
            '<div class="font-weight-bold">S$' + (item.price * item.quantity).toFixed(2) + '</div>' +
            '</div>';
    }).join('');
    
    /* ========== CALCULATE SHIPPING COST ========== */
    /* Shipping tiers based on subtotal amount */
    let ship = 0;
    if(currentFulfillment === 'delivery'){
        // Delivery pricing tiers:
        if(subtotal < 100) {
            ship = 3.50;      // Under $100: $3.50 shipping
        }
        else if(subtotal < 888) {
            ship = 1.50;      // $100 to $887.99: $1.50 shipping
        }
        else {
            ship = 0;         // $888 and above: FREE shipping
        }
    } else {
        // Pickup is always free
        ship = 0;
    }
    
    // Update price summary with calculated shipping
    updateTotals(subtotal, ship);
}

/* ========== UPDATE PRICE TOTALS AND INCENTIVE BAR ========== */
/* Updates subtotal, shipping, total, and delivery incentive progress */
function updateTotals(sub, ship){
    // Update price displays
    document.getElementById('summary-subtotal').innerText = 'S$' + sub.toFixed(2);
    document.getElementById('summary-shipping').innerText = (ship === 0) ? 'FREE' : 'S$' + ship.toFixed(2);
    document.getElementById('summary-total').innerText = 'S$' + (sub + ship).toFixed(2);
    
    // Show delivery incentive box for delivery orders under $888
    const box = document.getElementById('delivery-incentive-box');
    if(currentFulfillment === 'delivery' && sub < 888){
        box.style.display = 'block';
        
        // Determine next tier: $100 (reduced shipping) or $888 (free shipping)
        let target = sub < 100 ? 100 : 888;
        let diff = target - sub;
        
        // Update incentive text and progress bar
        document.getElementById('incentive-amount').innerText = 'S$' + diff.toFixed(2) + ' to go';
        document.getElementById('incentive-bar').style.width = (sub / target * 100) + '%';
    } else { 
        box.style.display = 'none'; 
    }
}

/* ========== UPDATE CART QUANTITY ========== */
/* Increases/decreases item quantity or removes item if quantity reaches 0 */
function updateQty(i, d){
    // Load cart from storage
    let cart = JSON.parse(localStorage.getItem('cart'));
    
    // Adjust quantity by delta (d = +1 or -1)
    cart[i].quantity += d;
    
    // Remove item if quantity drops below 1
    if(cart[i].quantity < 1) cart.splice(i, 1);
    
    // Save updated cart and refresh display
    localStorage.setItem('cart', JSON.stringify(cart));
    loadCheckoutCart();
}

/* ========== PROCESS PAYMENT ========== */
/* Validates payment details and submits order to server */
async function processPayment(){
    const btn = document.getElementById('btn-pay');
    const method = document.getElementById('payment-method').value;
    const savedCardId = document.getElementById('saved-card-id').value;
    const section = document.getElementById('payment-card-section');
    const errorMsg = document.getElementById('card-error-msg');
    
    // Clear previous error messages
    errorMsg.innerText = '';

    let cardDetails = null;

    /* ========== VALIDATE CREDIT CARD (IF NEW CARD) ========== */
    if(method === 'Credit Card' && savedCardId === 'new'){
        // Get card input values
        const cardName = document.getElementById('card-name').value.trim();
        const num = document.getElementById('card-number').value.replace(/\D/g, '');
        const exp = document.getElementById('card-exp').value.trim();
        const cvv = document.getElementById('card-cvv').value.trim();

        /* Validation 1: Check cardholder name */
        if(!cardName){
            section.classList.add('shake');
            errorMsg.innerText = 'Please enter the name on card.';
            setTimeout(function(){ section.classList.remove('shake'); }, 400);
            return;
        }

        /* Validation 2: Check card number (must be Visa/Mastercard and pass Luhn) */
        if((!num.startsWith('4') && !num.startsWith('5')) || !validateLuhn(num)){
            section.classList.add('shake');
            errorMsg.innerText = 'Please provide a valid VISA or Mastercard.';
            setTimeout(function(){ section.classList.remove('shake'); }, 400);
            return;
        }

        /* Validation 3: Check expiry date format (MM/YY) */
        if(!/^\d{2}\/\d{2}$/.test(exp)){
            section.classList.add('shake');
            errorMsg.innerText = 'Please enter expiry date as MM/YY.';
            setTimeout(function(){ section.classList.remove('shake'); }, 400);
            return;
        }

        /* Validation 4: Check CVV (3 or 4 digits) */
        if(!/^\d{3,4}$/.test(cvv)){
            section.classList.add('shake');
            errorMsg.innerText = 'Please enter a valid CVV.';
            setTimeout(function(){ section.classList.remove('shake'); }, 400);
            return;
        }

        /* All validations passed - prepare card details */
        cardDetails = {
            name: cardName,
            number: num,
            exp: exp,
            cvv: cvv,
            brand: detectCardBrand(num),
            last4: num.slice(-4) // Last 4 digits for saving
        };

        /* Save card if checkbox is checked */
        if(document.getElementById('save-card-checkbox').checked){
            saveCardToLocalStorage(cardDetails);
            loadSavedCards(); // Refresh saved cards dropdown
        }
    }

    /* ========== DISABLE BUTTON AND SHOW PROCESSING STATE ========== */
    btn.disabled = true;
    btn.innerHTML = 'Processing...';

    /* ========== GET PICKUP DATE OR DELIVERY ADDRESS ========== */
    let selectedDate = '';
    if(currentFulfillment === 'pickup'){
        selectedDate = document.getElementById('pickup-date').value || 'Not selected';
    } else {
        selectedDate = document.getElementById('delivery-address').value || 'Address not provided';
    }

    /* ========== PREPARE PAYMENT PAYLOAD ========== */
    const payload = {
        cart: JSON.parse(localStorage.getItem('cart')),
        total_amount: parseFloat(document.getElementById('summary-total').innerText.replace('S$', '')),
        fulfillment: currentFulfillment,
        payment_method: method,
        pickup_or_delivery_date: selectedDate
    };

    /* ========== SUBMIT PAYMENT TO SERVER ========== */
    try{
        // Send POST request to backend
        const res = await fetch('/process-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}' // CSRF protection token
            },
            body: JSON.stringify(payload)
        });
        
        // Parse JSON response
        const result = await res.json();

        if(result.success){
            /* ========== PAYMENT SUCCESSFUL ========== */
            
            // Prepare order data for success page
            const cart = JSON.parse(localStorage.getItem('cart'));
            const subtotal = parseFloat(document.getElementById('summary-subtotal').innerText.replace('S$', ''));
            const shippingText = document.getElementById('summary-shipping').innerText;
            const shipping = shippingText === 'FREE' ? 0 : parseFloat(shippingText.replace('S$', ''));
            const total = parseFloat(document.getElementById('summary-total').innerText.replace('S$', ''));
            
            var orderData = {
                cart: cart,
                subtotal: subtotal,
                shipping: shipping,
                total: total,
                payment_method: method
            };
            
            // Save order data to sessionStorage (for success page)
            sessionStorage.setItem('last_order', JSON.stringify(orderData));
            
            // Clear cart from localStorage (order complete)
            localStorage.removeItem('cart');
            
            // Redirect to success page with fulfillment details
            window.location.href = '/order-success?method=' + currentFulfillment + '&date=' + encodeURIComponent(selectedDate);
        } else {
            /* ========== PAYMENT FAILED ========== */
            alert(result.message);
            
            // Re-enable button
            btn.disabled = false;
            btn.innerHTML = 'CONFIRM!';
        }
    } catch(err){
        /* ========== ERROR HANDLING ========== */
        console.error(err);
        alert('Something went wrong. Please try again.');
        
        // Re-enable button
        btn.disabled = false;
        btn.innerHTML = 'CONFIRM!';
    }
}

/* ========== PAGE LOAD INITIALIZATION ========== */
/* Runs when page finishes loading */
document.addEventListener('DOMContentLoaded', function(){
    loadCheckoutCart();  // Load cart items and calculate totals
    loadSavedCards();    // Load saved payment cards
});

</script>

<!-- End of content block -->
{% endblock %}






