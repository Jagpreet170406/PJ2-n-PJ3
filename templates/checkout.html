{% extends "base.html" %}
{% block content %}
<div class="container mb-5" style="margin-top: 100px;">
    <h2 class="mb-4">Confirm Order & Huat! üßß</h2>
    <div class="row">
        <div class="col-md-8">
            <div class="card p-4 shadow-sm mb-4">
                <h5 class="font-weight-bold">1. Review Your Basket</h5>
                <hr>
                <div id="cart-items-container"></div>
            </div>

            <div class="card p-4 shadow-sm mb-4">
                <h5 class="font-weight-bold">2. Fulfillment</h5>
                <div class="row mt-3">
                    <div class="col-6">
                        <div class="p-3 border rounded text-center selection-box active" id="box-pickup" onclick="setFulfillment('pickup')">
                            <h3>üè™</h3><b>Self-Pickup</b><br><small class="text-success">FREE</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 border rounded text-center selection-box" id="box-delivery" onclick="setFulfillment('delivery')">
                            <h3>üöö</h3><b>Delivery</b><br><small class="text-primary">Tiered Rates</small>
                        </div>
                    </div>
                </div>
                <div id="delivery-address-section" class="mt-3 d-none">
                    <textarea id="delivery-address" class="form-control" placeholder="Full Delivery Address"></textarea>
                </div>
                <input type="date" id="fulfillment-date" class="form-control mt-3">
            </div>
        </div>

        <div class="col-md-4">
            <div class="card p-4 shadow-sm sticky-top border-primary" style="top: 110px;">
                <h4 class="font-weight-bold">Summary</h4>
                <div class="d-flex justify-content-between"><span>Subtotal</span><span id="summary-subtotal">S$0.00</span></div>
                <div class="d-flex justify-content-between"><span>Delivery</span><span id="summary-shipping">S$0.00</span></div>
                <div id="shipping-promo" class="alert alert-warning py-1 mt-2 small d-none"></div>
                <hr>
                <div class="d-flex justify-content-between h4 font-weight-bold"><span >Total</span><span id="summary-total" class="text-primary">S$0.00</span></div>
                <button id="btn-pay" class="btn btn-primary btn-block btn-lg mt-3" onclick="processPayment()">üí∞ CONFIRM & HUAT!</button>
            </div>
        </div>
    </div>
</div>

<style>
    .selection-box { cursor: pointer; transition: 0.3s; }
    .selection-box.active { border-color: #2563eb !important; background: #eff6ff; }
    .checkout-qty-card { display: flex; align-items: center; border: 1px solid #ddd; border-radius: 6px; background: white; }
    .checkout-qty-btn { border: none; background: none; padding: 2px 8px; cursor: pointer; font-weight: bold; }
</style>

<script>
let currentFulfillment = 'pickup';

function setFulfillment(method) {
    currentFulfillment = method;
    document.getElementById('box-pickup').classList.toggle('active', method === 'pickup');
    document.getElementById('box-delivery').classList.toggle('active', method === 'delivery');
    document.getElementById('delivery-address-section').classList.toggle('d-none', method === 'pickup');
    loadCheckoutCart();
}

function loadCheckoutCart() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const container = document.getElementById('cart-items-container');
    let subtotal = 0;
    
    if (cart.length === 0) {
        container.innerHTML = "Cart is empty!";
        return updateTotals(0, 0);
    }

    container.innerHTML = cart.map((item, i) => {
        subtotal += item.price * item.quantity;
        return `
        <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
            <div class="flex-grow-1"><b>${item.name}</b><br><small>S$${item.price.toFixed(2)}</small></div>
            <div class="checkout-qty-card mx-3">
                <button class="checkout-qty-btn" onclick="updateQty(${i}, -1)">‚àí</button>
                <span class="px-2">${item.quantity}</span>
                <button class="checkout-qty-btn" onclick="updateQty(${i}, 1)">+</button>
            </div>
            <div class="font-weight-bold" style="min-width: 80px;">S$${(item.price * item.quantity).toFixed(2)}</div>
            <button class="btn btn-link text-danger p-0 ml-2" onclick="updateQty(${i}, -999)">‚ùå</button>
        </div>`;
    }).join('');

    let ship = 0;
    if (currentFulfillment === 'delivery') {
        if (subtotal < 100) ship = 3.50;
        else if (subtotal <= 888) ship = 1.50;
        else ship = 0;
    }
    updateTotals(subtotal, ship);
}

function updateQty(i, delta) {
    let cart = JSON.parse(localStorage.getItem('cart'));
    cart[i].quantity += delta;
    if (cart[i].quantity < 1) cart.splice(i, 1);
    localStorage.setItem('cart', JSON.stringify(cart));
    loadCheckoutCart();
}

function updateTotals(sub, ship) {
    document.getElementById('summary-subtotal').innerText = `S$${sub.toFixed(2)}`;
    document.getElementById('summary-shipping').innerText = ship === 0 ? 'FREE' : `S$${ship.toFixed(2)}`;
    document.getElementById('summary-total').innerText = `S$${(sub + ship).toFixed(2)}`;
    
    const promo = document.getElementById('shipping-promo');
    if (currentFulfillment === 'delivery' && sub < 888) {
        promo.classList.remove('d-none');
        let nextTier = sub < 100 ? 100 : 888;
        promo.innerText = `Add S$${(nextTier - sub).toFixed(2)} more for cheaper shipping!`;
    } else promo.classList.add('d-none');
}

async function processPayment() {
    const btn = document.getElementById('btn-pay');
    btn.disabled = true;
    btn.innerHTML = "HUATING... üßß";
    // Send fetch request here...
    setTimeout(() => { 
        localStorage.removeItem('cart');
        window.location.href = "/order-success"; 
    }, 1500);
}

document.addEventListener('DOMContentLoaded', loadCheckoutCart);
</script>
{% endblock %}