{% extends "base.html" %}
{% block title %}Checkout - Chin Hon Motors{% endblock %}

{% block content %}
<div class="container mb-5" style="margin-top: 100px;">
    <h2 class="mb-4">Secure Checkout</h2>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card p-3 shadow-sm mb-4 border-0" style="background: #f8f9fa;">
                <h5 class="font-weight-bold">1. Review Items</h5>
                <hr>
                <div id="cart-items-container"></div>
            </div>

            <div class="card p-3 shadow-sm mb-4">
                <h5 class="font-weight-bold">2. Fulfillment Details</h5>
                <hr>
                <div class="btn-group btn-group-toggle d-flex mb-3" data-toggle="buttons">
                    <label class="btn btn-outline-dark flex-fill active py-3">
                        <input type="radio" name="fulfillment" id="method-pickup" value="pickup" checked onchange="updateFulfillmentUI()"> 
                        <strong>üè™ Self-Pickup</strong>
                    </label>
                    <label class="btn btn-outline-dark flex-fill py-3">
                        <input type="radio" name="fulfillment" id="method-delivery" value="delivery" onchange="updateFulfillmentUI()"> 
                        <strong>üöö Local Delivery</strong>
                    </label>
                </div>
                <div class="form-group mb-3">
                    <label class="font-weight-bold" id="date-label">üìÖ Select Date:</label>
                    <input type="date" id="fulfillment-date" class="form-control form-control-lg">
                </div>
            </div>

            <div class="card p-3 shadow-sm mb-4">
                <h5 class="font-weight-bold">3. Payment Method</h5>
                <hr>
                
                <div class="text-center mb-3" style="height: 50px;">
                    <img id="active-method-img" src="https://logo.clearbit.com/visa.com" height="40" alt="Payment Icon">
                </div>

                <select class="form-control form-control-lg mb-3" id="payment-method" onchange="togglePaymentFields()">
                    <option value="Credit Card">Credit / Debit Card</option>
                    <option value="PayNow">PayNow QR</option>
                    <option value="Google Pay">Google Pay</option>
                </select>

                <div id="card-details-section">
                    <div class="form-group mb-2">
                        <label class="small font-weight-bold">Cardholder Name</label>
                        <input type="text" id="card-name" class="form-control" placeholder="NAME ON CARD">
                    </div>
                    <div class="form-group mb-2 position-relative">
                        <label class="small font-weight-bold">Card Number</label>
                        <input type="text" id="card-number" class="form-control" placeholder="4xxx xxxx xxxx xxxx" maxlength="19" oninput="detectCardType()">
                        <div id="card-type-indicator" style="position: absolute; right: 10px; top: 35px;"></div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <label class="small font-weight-bold">Expiry</label>
                            <input type="text" id="card-expiry" class="form-control" placeholder="MM/YY" maxlength="5">
                        </div>
                        <div class="col-6">
                            <label class="small font-weight-bold">CVV (Required)</label>
                            <input type="text" id="card-cvv" class="form-control" placeholder="123" maxlength="3">
                        </div>
                    </div>
                    <div class="form-check mt-3">
                        <input type="checkbox" class="form-check-input" id="save-card-check">
                        <label class="form-check-label small" for="save-card-check">Securely remember card details for next time</label>
                    </div>
                </div>

                <div id="wallet-note" class="d-none alert alert-info mt-2">
                    <small>A secure payment window will open after clicking Place Order.</small>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card p-4 shadow-sm sticky-top border-dark" style="top: 110px; border-width: 2px;">
                <h4 class="font-weight-bold">Order Summary</h4>
                <hr>
                <div class="d-flex justify-content-between mb-2"><span>Subtotal</span><span id="summary-subtotal">S$0.00</span></div>
                <div class="d-flex justify-content-between mb-2"><span>Delivery</span><span id="summary-shipping">S$0.00</span></div>
                <hr>
                <div class="d-flex justify-content-between mb-4"><span class="h5 font-weight-bold">Total</span><span class="h5 font-weight-bold text-primary" id="summary-total">S$0.00</span></div>
                <button class="btn btn-dark btn-block btn-lg py-3 font-weight-bold" onclick="processPayment()">PLACE ORDER</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Use Clearbit for cleaner logos
    const methodIcons = {
        'Credit Card': 'https://logo.clearbit.com/visa.com',
        'PayNow': 'https://logo.clearbit.com/dbs.com.sg',
        'Google Pay': 'https://logo.clearbit.com/google.com',
        'Mastercard': 'https://logo.clearbit.com/mastercard.com'
    };

    function togglePaymentFields() {
        const method = document.getElementById('payment-method').value;
        const cardSection = document.getElementById('card-details-section');
        const walletNote = document.getElementById('wallet-note');
        const activeImg = document.getElementById('active-method-img');

        activeImg.src = methodIcons[method] || methodIcons['Credit Card'];
        
        if (method === 'Credit Card') {
            cardSection.classList.remove('d-none');
            walletNote.classList.add('d-none');
            loadSavedCard(); // Auto-fill if exists
        } else {
            cardSection.classList.add('d-none');
            walletNote.classList.remove('d-none');
        }
    }

    function detectCardType() {
        let input = document.getElementById('card-number');
        let number = input.value.replace(/\D/g, '');
        const activeImg = document.getElementById('active-method-img');
        input.value = number.replace(/(\d{4})(?=\d)/g, '$1 ').trim();

        if (number.startsWith('4')) activeImg.src = methodIcons['Credit Card'];
        else if (number.startsWith('5')) activeImg.src = methodIcons['Mastercard'];
    }

    // --- SAVE/LOAD CARD LOGIC ---
    function loadSavedCard() {
        const saved = JSON.parse(localStorage.getItem('savedCard'));
        if (saved) {
            document.getElementById('card-name').value = saved.name || '';
            document.getElementById('card-number').value = saved.maskedNumber || '';
            document.getElementById('card-expiry').value = saved.expiry || '';
            document.getElementById('save-card-check').checked = true;
            // Note: CVV is NEVER saved.
        }
    }

    async function processPayment() {
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        const method = document.getElementById('payment-method').value;
        const cardNumber = document.getElementById('card-number').value.replace(/\s+/g, '');
        const saveCheck = document.getElementById('save-card-check').checked;

        if (method === 'Credit Card') {
            if (cardNumber.length < 15 || !document.getElementById('card-cvv').value) {
                alert("Please complete card details."); return;
            }
            
            if (saveCheck) {
                const cardToSave = {
                    name: document.getElementById('card-name').value,
                    maskedNumber: "**** **** **** " + cardNumber.slice(-4),
                    expiry: document.getElementById('card-expiry').value
                };
                localStorage.setItem('savedCard', JSON.stringify(cardToSave));
            } else {
                localStorage.removeItem('savedCard');
            }
        }

        // ... existing fetch logic to /process-payment ...
        const response = await fetch('/process-payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': "{{ csrf_token() }}" },
            body: JSON.stringify({
                cart: cart,
                payment_method: method,
                fulfillment: document.querySelector('input[name="fulfillment"]:checked').value,
                fulfillment_date: document.getElementById('fulfillment-date').value,
                total_amount: parseFloat(document.getElementById('summary-total').innerText.replace('S$', ''))
            })
        });

        const result = await response.json();
        if (result.success) {
            localStorage.removeItem('cart');
            window.location.href = `/order-success?method=${payload.fulfillment}&date=${payload.fulfillment_date}`;
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        loadCheckoutCart(); // (Assume this function from previous code)
        updateFulfillmentUI(); 
        togglePaymentFields();
    });
</script>
{% endblock %}