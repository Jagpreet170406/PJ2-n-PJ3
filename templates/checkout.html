<!-- ============================================ -->
<!-- CHECKOUT PAGE - Order Confirmation & Payment -->
<!-- ============================================ -->

<!-- Template Setup: Extends base.html layout -->
{% extends "base.html" %}
{% block content %}

<style>
/* Date validation error styling (like market_analysis.html) */
.date-error {
  display: block;
  color: #f87171;
  font-size: 0.88rem;
  font-weight: 700;
  margin-top: 8px;
  letter-spacing: 0.01em;
  background: rgba(248, 113, 113, 0.10);
  border-left: 3px solid #f87171;
  padding: 6px 10px;
  border-radius: 0 6px 6px 0;
  visibility: visible;
}
.date-error:empty {
  visibility: hidden;
  background: none;
  border: none;
  padding: 0;
}
.form-control.input-error {
  border-color: #f87171 !important;
  box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.18) !important;
}
</style>

<!-- Main Container: Checkout page content with top margin to clear navbar -->
<div class="container mb-5" style="margin-top: 100px;">
    
    <!-- Page Title -->
    <h2 class="mb-4">Confirm Order</h2>
    
    <!-- Two-Column Layout: Left = Forms, Right = Bill Summary -->
    <div class="row">
        
        <!-- ============================================ -->
        <!-- LEFT COLUMN: Order Details & Payment Forms -->
        <!-- ============================================ -->
        <div class="col-md-8">

            <!-- ========== SECTION 1: REVIEW BASKET ========== -->
            <!-- Shows all items in cart with quantity adjusters -->
            <div class="card p-4 shadow-sm mb-4 border-0" style="border-left: 5px solid #2563eb !important; background: #fdfdfd;">
                <h5 class="font-weight-bold">1. Review Your Basket</h5>
                <hr>
                <!-- Cart items will be dynamically loaded here by JavaScript -->
                <div id="cart-items-container"></div>
            </div>

            <!-- ========== SECTION 2: FULFILLMENT METHOD ========== -->
            <!-- Choose between Self-Pickup or Delivery -->
            <div class="card p-4 shadow-sm mb-4">
                <h5 class="font-weight-bold">2. Fulfillment Method</h5>
                
                <!-- Two Selection Boxes: Pickup vs Delivery -->
                <div class="row mt-3">
                    
                    <!-- Self-Pickup Option (Default Active) -->
                    <div class="col-6">
                        <div class="p-3 border rounded text-center selection-box active" 
                             id="box-pickup" 
                             onclick="setFulfillment('pickup')">
                            <h3>üè™</h3>
                            <b>Self-Pickup</b>
                        </div>
                    </div>
                    
                    <!-- Local Delivery Option -->
                    <div class="col-6">
                        <div class="p-3 border rounded text-center selection-box" 
                             id="box-delivery" 
                             onclick="setFulfillment('delivery')">
                            <h3>üöö</h3>
                            <b>Local Delivery</b>
                        </div>
                    </div>
                </div>

                <!-- Pickup Date Selector (Shows when Pickup is selected) -->
                <div id="pickup-date-section" class="mt-3">
                    <label><span style="color: red; font-size: 1.2em; font-weight: bold;">*</span> üìÖ Pick-up Date</label>
                    <input type="date" id="pickup-date" class="form-control" required>
                    <span class="date-error" id="pickup-date-error"></span>
                </div>

                <!-- Phone number field with country selector -->
                <div class="mt-3">
                    <label><span style="color: red; font-size: 1.2em; font-weight: bold;">*</span> üì± Phone Number</label>
                    <div class="row">
                        <div class="col-5">
                            <select id="country-code" class="form-control" required>
                                <option value="">Select Country</option>
                                <option value="+93" data-country="AF">Afghanistan (+93)</option>
                                <option value="+355" data-country="AL">Albania (+355)</option>
                                <option value="+213" data-country="DZ">Algeria (+213)</option>
                                <option value="+1" data-country="US">America (+1)</option>
                                <option value="+376" data-country="AD">Andorra (+376)</option>
                                <option value="+244" data-country="AO">Angola (+244)</option>
                                <option value="+54" data-country="AR">Argentina (+54)</option>
                                <option value="+374" data-country="AM">Armenia (+374)</option>
                                <option value="+61" data-country="AU">Australia (+61)</option>
                                <option value="+43" data-country="AT">Austria (+43)</option>
                                <option value="+994" data-country="AZ">Azerbaijan (+994)</option>
                                <option value="+973" data-country="BH">Bahrain (+973)</option>
                                <option value="+880" data-country="BD">Bangladesh (+880)</option>
                                <option value="+375" data-country="BY">Belarus (+375)</option>
                                <option value="+32" data-country="BE">Belgium (+32)</option>
                                <option value="+501" data-country="BZ">Belize (+501)</option>
                                <option value="+229" data-country="BJ">Benin (+229)</option>
                                <option value="+975" data-country="BT">Bhutan (+975)</option>
                                <option value="+591" data-country="BO">Bolivia (+591)</option>
                                <option value="+387" data-country="BA">Bosnia (+387)</option>
                                <option value="+267" data-country="BW">Botswana (+267)</option>
                                <option value="+55" data-country="BR">Brazil (+55)</option>
                                <option value="+673" data-country="BN">Brunei (+673)</option>
                                <option value="+359" data-country="BG">Bulgaria (+359)</option>
                                <option value="+226" data-country="BF">Burkina Faso (+226)</option>
                                <option value="+257" data-country="BI">Burundi (+257)</option>
                                <option value="+855" data-country="KH">Cambodia (+855)</option>
                                <option value="+237" data-country="CM">Cameroon (+237)</option>
                                <option value="+1" data-country="CA">Canada (+1)</option>
                                <option value="+238" data-country="CV">Cape Verde (+238)</option>
                                <option value="+236" data-country="CF">Central African Rep (+236)</option>
                                <option value="+235" data-country="TD">Chad (+235)</option>
                                <option value="+56" data-country="CL">Chile (+56)</option>
                                <option value="+86" data-country="CN">China (+86)</option>
                                <option value="+57" data-country="CO">Colombia (+57)</option>
                                <option value="+506" data-country="CR">Costa Rica (+506)</option>
                                <option value="+385" data-country="HR">Croatia (+385)</option>
                                <option value="+53" data-country="CU">Cuba (+53)</option>
                                <option value="+357" data-country="CY">Cyprus (+357)</option>
                                <option value="+420" data-country="CZ">Czech Republic (+420)</option>
                                <option value="+45" data-country="DK">Denmark (+45)</option>
                                <option value="+253" data-country="DJ">Djibouti (+253)</option>
                                <option value="+593" data-country="EC">Ecuador (+593)</option>
                                <option value="+20" data-country="EG">Egypt (+20)</option>
                                <option value="+503" data-country="SV">El Salvador (+503)</option>
                                <option value="+372" data-country="EE">Estonia (+372)</option>
                                <option value="+251" data-country="ET">Ethiopia (+251)</option>
                                <option value="+679" data-country="FJ">Fiji (+679)</option>
                                <option value="+358" data-country="FI">Finland (+358)</option>
                                <option value="+33" data-country="FR">France (+33)</option>
                                <option value="+241" data-country="GA">Gabon (+241)</option>
                                <option value="+220" data-country="GM">Gambia (+220)</option>
                                <option value="+995" data-country="GE">Georgia (+995)</option>
                                <option value="+49" data-country="DE">Germany (+49)</option>
                                <option value="+233" data-country="GH">Ghana (+233)</option>
                                <option value="+30" data-country="GR">Greece (+30)</option>
                                <option value="+502" data-country="GT">Guatemala (+502)</option>
                                <option value="+224" data-country="GN">Guinea (+224)</option>
                                <option value="+592" data-country="GY">Guyana (+592)</option>
                                <option value="+509" data-country="HT">Haiti (+509)</option>
                                <option value="+504" data-country="HN">Honduras (+504)</option>
                                <option value="+852" data-country="HK">Hong Kong (+852)</option>
                                <option value="+36" data-country="HU">Hungary (+36)</option>
                                <option value="+354" data-country="IS">Iceland (+354)</option>
                                <option value="+91" data-country="IN">India (+91)</option>
                                <option value="+62" data-country="ID">Indonesia (+62)</option>
                                <option value="+98" data-country="IR">Iran (+98)</option>
                                <option value="+964" data-country="IQ">Iraq (+964)</option>
                                <option value="+353" data-country="IE">Ireland (+353)</option>
                                <option value="+972" data-country="IL">Israel (+972)</option>
                                <option value="+39" data-country="IT">Italy (+39)</option>
                                <option value="+81" data-country="JP">Japan (+81)</option>
                                <option value="+962" data-country="JO">Jordan (+962)</option>
                                <option value="+7" data-country="KZ">Kazakhstan (+7)</option>
                                <option value="+254" data-country="KE">Kenya (+254)</option>
                                <option value="+965" data-country="KW">Kuwait (+965)</option>
                                <option value="+996" data-country="KG">Kyrgyzstan (+996)</option>
                                <option value="+856" data-country="LA">Laos (+856)</option>
                                <option value="+371" data-country="LV">Latvia (+371)</option>
                                <option value="+961" data-country="LB">Lebanon (+961)</option>
                                <option value="+231" data-country="LR">Liberia (+231)</option>
                                <option value="+218" data-country="LY">Libya (+218)</option>
                                <option value="+370" data-country="LT">Lithuania (+370)</option>
                                <option value="+352" data-country="LU">Luxembourg (+352)</option>
                                <option value="+853" data-country="MO">Macau (+853)</option>
                                <option value="+389" data-country="MK">Macedonia (+389)</option>
                                <option value="+261" data-country="MG">Madagascar (+261)</option>
                                <option value="+265" data-country="MW">Malawi (+265)</option>
                                <option value="+60" data-country="MY">Malaysia (+60)</option>
                                <option value="+960" data-country="MV">Maldives (+960)</option>
                                <option value="+223" data-country="ML">Mali (+223)</option>
                                <option value="+356" data-country="MT">Malta (+356)</option>
                                <option value="+52" data-country="MX">Mexico (+52)</option>
                                <option value="+373" data-country="MD">Moldova (+373)</option>
                                <option value="+377" data-country="MC">Monaco (+377)</option>
                                <option value="+976" data-country="MN">Mongolia (+976)</option>
                                <option value="+382" data-country="ME">Montenegro (+382)</option>
                                <option value="+212" data-country="MA">Morocco (+212)</option>
                                <option value="+258" data-country="MZ">Mozambique (+258)</option>
                                <option value="+95" data-country="MM">Myanmar (+95)</option>
                                <option value="+264" data-country="NA">Namibia (+264)</option>
                                <option value="+977" data-country="NP">Nepal (+977)</option>
                                <option value="+31" data-country="NL">Netherlands (+31)</option>
                                <option value="+64" data-country="NZ">New Zealand (+64)</option>
                                <option value="+505" data-country="NI">Nicaragua (+505)</option>
                                <option value="+227" data-country="NE">Niger (+227)</option>
                                <option value="+234" data-country="NG">Nigeria (+234)</option>
                                <option value="+850" data-country="KP">North Korea (+850)</option>
                                <option value="+47" data-country="NO">Norway (+47)</option>
                                <option value="+968" data-country="OM">Oman (+968)</option>
                                <option value="+92" data-country="PK">Pakistan (+92)</option>
                                <option value="+507" data-country="PA">Panama (+507)</option>
                                <option value="+595" data-country="PY">Paraguay (+595)</option>
                                <option value="+51" data-country="PE">Peru (+51)</option>
                                <option value="+63" data-country="PH">Philippines (+63)</option>
                                <option value="+48" data-country="PL">Poland (+48)</option>
                                <option value="+351" data-country="PT">Portugal (+351)</option>
                                <option value="+974" data-country="QA">Qatar (+974)</option>
                                <option value="+40" data-country="RO">Romania (+40)</option>
                                <option value="+7" data-country="RU">Russia (+7)</option>
                                <option value="+250" data-country="RW">Rwanda (+250)</option>
                                <option value="+966" data-country="SA">Saudi Arabia (+966)</option>
                                <option value="+221" data-country="SN">Senegal (+221)</option>
                                <option value="+381" data-country="RS">Serbia (+381)</option>
                                <option value="+65" data-country="SG" selected>Singapore (+65)</option>
                                <option value="+421" data-country="SK">Slovakia (+421)</option>
                                <option value="+386" data-country="SI">Slovenia (+386)</option>
                                <option value="+27" data-country="ZA">South Africa (+27)</option>
                                <option value="+82" data-country="KR">South Korea (+82)</option>
                                <option value="+34" data-country="ES">Spain (+34)</option>
                                <option value="+94" data-country="LK">Sri Lanka (+94)</option>
                                <option value="+249" data-country="SD">Sudan (+249)</option>
                                <option value="+597" data-country="SR">Suriname (+597)</option>
                                <option value="+46" data-country="SE">Sweden (+46)</option>
                                <option value="+41" data-country="CH">Switzerland (+41)</option>
                                <option value="+963" data-country="SY">Syria (+963)</option>
                                <option value="+886" data-country="TW">Taiwan (+886)</option>
                                <option value="+992" data-country="TJ">Tajikistan (+992)</option>
                                <option value="+255" data-country="TZ">Tanzania (+255)</option>
                                <option value="+66" data-country="TH">Thailand (+66)</option>
                                <option value="+228" data-country="TG">Togo (+228)</option>
                                <option value="+216" data-country="TN">Tunisia (+216)</option>
                                <option value="+90" data-country="TR">Turkey (+90)</option>
                                <option value="+993" data-country="TM">Turkmenistan (+993)</option>
                                <option value="+256" data-country="UG">Uganda (+256)</option>
                                <option value="+380" data-country="UA">Ukraine (+380)</option>
                                <option value="+971" data-country="AE">UAE (+971)</option>
                                <option value="+44" data-country="GB">United Kingdom (+44)</option>
                                <option value="+598" data-country="UY">Uruguay (+598)</option>
                                <option value="+998" data-country="UZ">Uzbekistan (+998)</option>
                                <option value="+58" data-country="VE">Venezuela (+58)</option>
                                <option value="+84" data-country="VN">Vietnam (+84)</option>
                                <option value="+967" data-country="YE">Yemen (+967)</option>
                                <option value="+260" data-country="ZM">Zambia (+260)</option>
                                <option value="+263" data-country="ZW">Zimbabwe (+263)</option>
                            </select>
                        </div>
                        <div class="col-7">
                            <input type="tel" id="customer-phone" class="form-control" placeholder="e.g. 91234567" required>
                        </div>
                    </div>
                    <span class="date-error" id="customer-phone-error"></span>
                    <small class="text-muted" style="display:block; margin-top:4px;">Select your country and enter your phone number (without country code).</small>
                </div>

                <!-- Delivery Address Input (Shows when Delivery is selected, hidden by default) -->
                <div id="delivery-address-section" class="mt-3 d-none">
                    <label><span style="color: red; font-size: 1.2em; font-weight: bold;">*</span> üìç Delivery Address</label>
                    <textarea id="delivery-address" 
                              class="form-control" 
                              placeholder="e.g., Blk 123 Orchard Road, #01-234, Singapore 238867"
                              rows="3"
                              required></textarea>
                    <span class="date-error" id="delivery-address-error"></span>
                    <small class="text-muted" style="display: block; margin-top: 5px;">
                        Please include: Street/Block, Unit Number, Postal/Zip Code, Country (if outside Singapore)
                    </small>
                </div>
            </div>

            <!-- ========== SECTION 3: PAYMENT DETAILS ========== -->
            <!-- Credit card, PayNow, or PayLah payment options -->
            <div class="card p-4 shadow-sm mb-4" id="payment-card-section">
                <h5 class="font-weight-bold">3. Payment Details</h5>
                <hr>
                
                <!-- Payment Method Logo Display (Visa, Mastercard, PayNow, PayLah) -->
                <div class="text-center mb-3" style="height: 55px; display: flex; align-items: center; justify-content: center;">
                    <img id="card-logo" 
                         src="{{ url_for('static', filename='checkout/visa.png') }}" 
                         height="45" 
                         style="transition: all 0.3s ease; object-fit: contain; display:none;">
                </div>

                <!-- Payment Method Selector Dropdown -->
                <select class="form-control form-control-lg mb-4" 
                        id="payment-method" 
                        onchange="togglePaymentMethod()">
                    <option value="Credit Card">Credit / Debit Card</option>
                    <option value="PayNow">PayNow (QR Code)</option>
                    <option value="PayLah">DBS PayLah!</option>
                </select>

                <!-- Saved Cards Dropdown (Only shows for Credit Card option) -->
                <div id="saved-cards-wrapper" class="mb-3">
                    <label class="small font-weight-bold text-muted text-uppercase">Select a Saved Card</label>
                    <select class="form-control mb-3" 
                            id="saved-card-id" 
                            onchange="handleSavedCardChange()">
                        <!-- Default: Use new card -->
                        <option value="new">+ Use a new card</option>
                        <!-- Saved cards will be loaded here by JavaScript -->
                    </select>
                </div>

                <!-- Credit Card Input Fields (Shows when entering new card) -->
                <div id="card-details-section">
                    <!-- Cardholder Name -->
                    <label class="small font-weight-bold text-muted" style="display:block; margin-bottom:0.25rem;"><span style="color: red; font-size: 1.2em; font-weight: bold;">*</span> NAME ON CARD</label>
                    <input type="text" 
                           id="card-name" 
                           class="form-control mb-2" 
                           placeholder="NAME ON CARD">
                    
                    <!-- Card Number (Auto-detects Visa/Mastercard and formats with spaces) -->
                    <label class="small font-weight-bold text-muted" style="display:block; margin-bottom:0.25rem;"><span style="color: red; font-size: 1.2em; font-weight: bold;">*</span> CARD NUMBER</label>
                    <input type="tel" 
                           id="card-number" 
                           class="form-control mb-2" 
                           placeholder="CARD NUMBER" 
                           maxlength="19" 
                           oninput="detectCard(this.value)">
                    
                    <!-- Expiry Date and CVV Row -->
                    <div class="row">
                        <!-- Expiry Date (MM/YY format) -->
                        <div class="col-6">
                            <label class="small font-weight-bold text-muted" style="display:block; margin-bottom:0.25rem;"><span style="color: red; font-size: 1.2em; font-weight: bold;">*</span> EXPIRY</label>
                            <input type="tel" 
                                   id="card-exp" 
                                   class="form-control" 
                                   placeholder="MM/YY" 
                                   maxlength="5">
                        </div>
                        
                        <!-- CVV Security Code -->
                        <div class="col-6">
                            <label class="small font-weight-bold text-muted" style="display:block; margin-bottom:0.25rem;"><span style="color: red; font-size: 1.2em; font-weight: bold;">*</span> CVV</label>
                            <input type="password" 
                                   id="card-cvv" 
                                   class="form-control" 
                                   placeholder="CVV" 
                                   maxlength="4">
                        </div>
                    </div>
                    
                    <!-- Save Card Checkbox (Saves card to browser localStorage) -->
                    <div class="custom-control custom-checkbox mt-3">
                        <input type="checkbox" 
                               class="custom-control-input" 
                               id="save-card-checkbox" 
                               checked>
                        <label class="custom-control-label text-primary font-weight-bold" 
                               for="save-card-checkbox" 
                               style="cursor:pointer;">
                            Save card securely in this browser for future orders
                        </label>
                    </div>
                </div>
                
                <!-- Error Message Display (Shows validation errors) -->
                <div id="card-error-msg" class="text-danger small mt-2 font-weight-bold"></div>
            </div>
        </div>

        <!-- ============================================ -->
        <!-- RIGHT COLUMN: BILL SUMMARY (Sticky Sidebar) -->
        <!-- ============================================ -->
        <div class="col-md-4">
            <!-- Sticky Bill Summary Card (Follows you when scrolling) -->
            <div class="card p-4 shadow-sm sticky-top border-primary" style="top: 110px; border-width: 2px;">
                
                <h4 class="font-weight-bold">Bill Summary</h4>
                
                <!-- ========== DELIVERY INCENTIVE BOX ========== -->
                <!-- Shows progress to free delivery (hidden by default) -->
                <div id="delivery-incentive-box" 
                     class="p-3 mb-3 rounded" 
                     style="display: none; background: #fffbeb; border: 1px solid #fcd34d;">
                    
                    <!-- Incentive Text and Amount Needed -->
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="font-weight-bold text-dark" id="incentive-text">Next Tier</small>
                        <small class="font-weight-bold" id="incentive-amount"></small>
                    </div>
                    
                    <!-- Progress Bar (Animated) -->
                    <div class="progress" style="height: 8px;">
                        <div id="incentive-bar" 
                             class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                             role="progressbar" 
                             style="width: 0%"></div>
                    </div>
                </div>

                <!-- ========== PRICE BREAKDOWN ========== -->
                
                <!-- Subtotal (Before shipping) -->
                <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal</span>
                    <span id="summary-subtotal">S$0.00</span>
                </div>
                
                <!-- Delivery Fee (Shows "FREE" or amount) -->
                <div class="d-flex justify-content-between mb-2">
                    <span>Delivery Fee</span>
                    <span id="summary-shipping">S$0.00</span>
                </div>
                
                <hr>
                
                <!-- Grand Total -->
                <div class="d-flex justify-content-between mb-4">
                    <span class="h4 font-weight-bold">Total</span>
                    <span class="h4 font-weight-bold text-primary" id="summary-total">S$0.00</span>
                </div>
                
                <!-- ========== PAYMENT BUTTON ========== -->
                <!-- Triggers payment processing -->
                <button id="btn-pay" 
                        class="btn btn-primary btn-block btn-lg py-3 font-weight-bold" 
                        onclick="processPayment()">
                    CONFIRM!
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- CSS STYLING -->
<!-- ============================================ -->
<style>
/* Selection Box: Pickup/Delivery option boxes with hover effect */
.selection-box { 
    cursor: pointer; 
    transition: 0.3s; 
    border: 2px solid #eee; 
    border-radius: 12px; 
}

/* Active Selection: Highlighted with blue border and light blue background */
.selection-box.active { 
    border-color: #2563eb; 
    background: #eff6ff; 
}

/* Quantity Card in Checkout: +/- buttons for adjusting item quantities */
.checkout-qty-card { 
    display: flex; 
    align-items: center; 
    border: 1px solid #ddd; 
    border-radius: 6px; 
    padding: 2px 5px; 
    background: #fff; 
}

/* Shake Animation: Used for error feedback on invalid card input */
@keyframes shake { 
    0% { transform: translateX(0); } 
    25% { transform: translateX(-5px); } 
    50% { transform: translateX(5px); } 
    75% { transform: translateX(-5px); } 
    100% { transform: translateX(0); } 
}

/* Shake Class: Applied to payment section when validation fails */
.shake { 
    animation: shake 0.4s ease-in-out; 
    border: 2px solid #dc3545 !important; /* Red border for error */
}
</style>

<!-- ============================================ -->
<!-- JAVASCRIPT SECTION -->
<!-- ============================================ -->
<script>

/* ========== GLOBAL VARIABLE ========== */
/* Tracks current fulfillment method (pickup or delivery) */
let currentFulfillment = 'pickup';

/* ========== LOAD SAVED CARDS FROM LOCALSTORAGE ========== */
/* Populates the saved cards dropdown with previously saved cards */
function loadSavedCards(){
    // Get saved cards from browser storage
    const savedCards = JSON.parse(localStorage.getItem('saved_cards') || '[]');
    const select = document.getElementById('saved-card-id');
    
    // Reset dropdown to default option
    select.innerHTML = '<option value="new">+ Use a new card</option>';
    
    // Add each saved card as an option
    savedCards.forEach(function(card, index){
        const option = document.createElement('option');
        option.value = index; // Index used to retrieve card later
        option.textContent = 'üí≥ ' + card.brand + ' ending in ' + card.last4 + ' (Exp: ' + card.exp + ')';
        select.appendChild(option);
    });
}

/* ========== SAVE CARD TO LOCALSTORAGE ========== */
/* Stores card details in browser for future use (NOT sent to server) */
function saveCardToLocalStorage(cardDetails){
    // Load existing saved cards
    const savedCards = JSON.parse(localStorage.getItem('saved_cards') || '[]');
    
    // Check if this card already exists (same last 4 digits and expiry)
    const exists = savedCards.some(function(card){
        return card.last4 === cardDetails.last4 && card.exp === cardDetails.exp;
    });
    
    // Only save if it's a new card
    if(!exists){
        savedCards.push({
            brand: cardDetails.brand,      // Visa or Mastercard
            last4: cardDetails.last4,      // Last 4 digits
            exp: cardDetails.exp,          // Expiry date (MM/YY)
            name: cardDetails.name         // Cardholder name
        });
        localStorage.setItem('saved_cards', JSON.stringify(savedCards));
        console.log('Card saved to browser!');
    } else {
        console.log('Card already saved');
    }
}

/* ========== LUHN ALGORITHM VALIDATION ========== */
/* Validates credit card number using industry-standard Luhn checksum */
/* Returns true if card number is mathematically valid */
function validateLuhn(number){
    let sum = 0;
    let isSecond = false;
    
    // Loop through digits from right to left
    for(let i = number.length - 1; i >= 0; i--){
        let d = parseInt(number.charAt(i));
        
        // Double every second digit
        if(isSecond){
            d *= 2;
            // If result is > 9, subtract 9
            if(d > 9) d -= 9;
        }
        
        sum += d;
        isSecond = !isSecond;
    }
    
    // Valid if sum is divisible by 10
    return (sum % 10) == 0;
}

/* ========== DETECT CARD TYPE AND FORMAT NUMBER ========== */
/* Auto-detects Visa/Mastercard and displays logo, formats number with spaces */
function detectCard(val){
    const logo = document.getElementById('card-logo');
    const input = document.getElementById('card-number');
    
    // Remove all non-digit characters
    const num = val.replace(/\D/g, '');
    
    // Format with spaces every 4 digits (e.g., "1234 5678 9012 3456")
    input.value = num.replace(/(\d{4})(?=\d)/g, '$1 ').trim();
    
    // Image paths for card logos
    const VISA = "{{ url_for('static', filename='checkout/visa.png') }}";
    const MC = "{{ url_for('static', filename='checkout/mastercard.png') }}";
    
    // Detect card brand by first digit
    if(num.startsWith('4')){ 
        // Visa cards start with 4
        logo.src = VISA; 
        logo.style.display = 'inline'; 
    }
    else if(num.startsWith('5')){ 
        // Mastercard starts with 5
        logo.src = MC; 
        logo.style.display = 'inline'; 
    }
    else{ 
        // Unknown card type
        logo.style.display = 'none'; 
    }
}

/* ========== DETECT CARD BRAND ========== */
/* Returns "Visa", "Mastercard", or "Unknown" based on first digit */
function detectCardBrand(num){
    if(num.startsWith('4')) return 'Visa';
    if(num.startsWith('5')) return 'Mastercard';
    return 'Unknown';
}

/* ========== HANDLE SAVED CARD SELECTION ========== */
/* When user selects a saved card, hide input fields and populate with saved data */
function handleSavedCardChange(){
    const val = document.getElementById('saved-card-id').value;
    const cardDetailsSection = document.getElementById('card-details-section');
    const logo = document.getElementById('card-logo');
    
    if(val === 'new'){
        // User wants to enter a new card
        cardDetailsSection.style.display = 'block';
        
        // Clear all input fields
        document.getElementById('card-name').value = '';
        document.getElementById('card-number').value = '';
        document.getElementById('card-exp').value = '';
        document.getElementById('card-cvv').value = '';
        
        // Hide logo
        logo.style.display = 'none';
    } else {
        // User selected a saved card
        const savedCards = JSON.parse(localStorage.getItem('saved_cards') || '[]');
        const card = savedCards[parseInt(val)];
        
        if(card){
            // Populate fields with saved card data (masked number)
            document.getElementById('card-name').value = card.name || '';
            document.getElementById('card-number').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ' + card.last4;
            document.getElementById('card-exp').value = card.exp;
            
            // Show card logo based on saved brand
            const VISA = "{{ url_for('static', filename='checkout/visa.png') }}";
            const MC = "{{ url_for('static', filename='checkout/mastercard.png') }}";
            
            if(card.brand === 'Visa'){
                logo.src = VISA;
                logo.style.display = 'inline';
            } else if(card.brand === 'Mastercard'){
                logo.src = MC;
                logo.style.display = 'inline';
            } else {
                logo.style.display = 'none';
            }
        }
        
        // Hide input section (card already selected)
        cardDetailsSection.style.display = 'none';
    }
}

/* ========== TOGGLE PAYMENT METHOD ========== */
/* Switches between Credit Card, PayNow, and PayLah displays */
function togglePaymentMethod(){
    const method = document.getElementById('payment-method').value;
    const logo = document.getElementById('card-logo');
    const cardSection = document.getElementById('card-details-section');
    const savedCardsWrapper = document.getElementById('saved-cards-wrapper');
    
    // Image paths for payment methods
    const PAYNOW = "{{ url_for('static', filename='checkout/paynow.jpg') }}";
    const PAYLAH = "{{ url_for('static', filename='checkout/paylah.png') }}";
    
    if(method === 'Credit Card'){
        // Show card input fields and saved cards dropdown
        cardSection.style.display = 'block';
        savedCardsWrapper.style.display = 'block';
        handleSavedCardChange(); // Load saved card if selected
    }
    else if(method === 'PayNow'){
        // Hide card inputs, show PayNow logo
        cardSection.style.display = 'none';
        savedCardsWrapper.style.display = 'none';
        logo.src = PAYNOW;
        logo.style.display = 'inline';
    }
    else if(method === 'PayLah'){
        // Hide card inputs, show PayLah logo
        cardSection.style.display = 'none';
        savedCardsWrapper.style.display = 'none';
        logo.src = PAYLAH;
        logo.style.display = 'inline';
    }
}

/* ========== SET FULFILLMENT METHOD ========== */
/* Switches between Pickup and Delivery options */
function setFulfillment(method){
    currentFulfillment = method;
    
    // Toggle active class on selection boxes
    document.getElementById('box-pickup').classList.toggle('active', method === 'pickup');
    document.getElementById('box-delivery').classList.toggle('active', method === 'delivery');
    
    // Show/hide appropriate date/address sections
    document.getElementById('delivery-address-section').classList.toggle('d-none', method === 'pickup');
    document.getElementById('pickup-date-section').classList.toggle('d-none', method === 'delivery');
    
    // Recalculate totals (delivery affects shipping cost)
    loadCheckoutCart();
}

/* ========== LOAD CART ITEMS INTO CHECKOUT ========== */
/* Displays all cart items with quantity controls and calculates totals */
function loadCheckoutCart(){
    // Load cart from localStorage
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const container = document.getElementById('cart-items-container');
    let subtotal = 0;
    
    // Build HTML for each cart item
    container.innerHTML = cart.map(function(item, i){
        subtotal += item.price * item.quantity;
        
        return '<div class="d-flex align-items-center mb-3 pb-3 border-bottom">' +
            // Product Image
            '<img src="' + item.image + '" style="width:50px;height:50px;object-fit:contain;margin-right:15px;">' +
            
            // Product Name and Price
            '<div class="flex-grow-1">' +
                '<b>' + item.name + '</b><br>' +
                '<small>S$' + item.price.toFixed(2) + '</small>' +
            '</div>' +
            
            // Quantity Adjuster (+/- buttons)
            '<div class="checkout-qty-card mx-2">' +
                '<button class="btn btn-sm" onclick="updateQty(' + i + ',-1)">‚àí</button>' +
                '<span class="px-2">' + item.quantity + '</span>' +
                '<button class="btn btn-sm" onclick="updateQty(' + i + ',1)">+</button>' +
            '</div>' +
            
            // Item Total (price √ó quantity)
            '<div class="font-weight-bold">S$' + (item.price * item.quantity).toFixed(2) + '</div>' +
            '</div>';
    }).join('');
    
    /* ========== CALCULATE SHIPPING COST ========== */
    /* Shipping tiers based on subtotal amount */
    let ship = 0;
    if(currentFulfillment === 'delivery'){
        // Delivery pricing tiers:
        if(subtotal < 100) {
            ship = 3.50;      // Under $100: $3.50 shipping
        }
        else if(subtotal < 888) {
            ship = 1.50;      // $100 to $887.99: $1.50 shipping
        }
        else {
            ship = 0;         // $888 and above: FREE shipping
        }
    } else {
        // Pickup is always free
        ship = 0;
    }
    
    // Update price summary with calculated shipping
    updateTotals(subtotal, ship);
}

/* ========== UPDATE PRICE TOTALS AND INCENTIVE BAR ========== */
/* Updates subtotal, shipping, total, and delivery incentive progress */
function updateTotals(sub, ship){
    // Update price displays
    document.getElementById('summary-subtotal').innerText = 'S$' + sub.toFixed(2);
    document.getElementById('summary-shipping').innerText = (ship === 0) ? 'FREE' : 'S$' + ship.toFixed(2);
    document.getElementById('summary-total').innerText = 'S$' + (sub + ship).toFixed(2);
    
    // Show delivery incentive box for delivery orders under $888
    const box = document.getElementById('delivery-incentive-box');
    if(currentFulfillment === 'delivery' && sub < 888){
        box.style.display = 'block';
        
        // Determine next tier: $100 (reduced shipping) or $888 (free shipping)
        let target = sub < 100 ? 100 : 888;
        let diff = target - sub;
        
        // Update incentive text and progress bar
        document.getElementById('incentive-amount').innerText = 'S$' + diff.toFixed(2) + ' to go';
        document.getElementById('incentive-bar').style.width = (sub / target * 100) + '%';
    } else { 
        box.style.display = 'none'; 
    }
}

/* ========== UPDATE CART QUANTITY ========== */
/* Increases/decreases item quantity or removes item if quantity reaches 0 */
function updateQty(i, d){
    // Load cart from storage
    let cart = JSON.parse(localStorage.getItem('cart'));
    
    // Adjust quantity by delta (d = +1 or -1)
    cart[i].quantity += d;
    
    // Remove item if quantity drops below 1
    if(cart[i].quantity < 1) cart.splice(i, 1);
    
    // Save updated cart and refresh display
    localStorage.setItem('cart', JSON.stringify(cart));
    
    // Dispatch custom event for real-time updates across tabs/windows
    window.dispatchEvent(new CustomEvent('cartUpdated'));
    
    // Update cart badge immediately
    updateCartBadge();
    
    loadCheckoutCart();
}

/* ========== UPDATE CART BADGE FUNCTION ========== */
function updateCartBadge() {
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const total = cart.reduce((sum, item) => sum + item.quantity, 0);
    const badge = document.querySelector('.cart-badge');
    
    if (badge) {
        badge.textContent = total;
        badge.style.display = total > 0 ? 'inline-block' : 'none';
    }
}

/* ========== PROCESS PAYMENT ========== */
/* Validates payment details and submits order to server */
async function processPayment(){
    const btn = document.getElementById('btn-pay');
    const method = document.getElementById('payment-method').value;
    const savedCardId = document.getElementById('saved-card-id').value;
    const section = document.getElementById('payment-card-section');
    const errorMsg = document.getElementById('card-error-msg');
    
    // Clear previous error messages
    errorMsg.innerText = '';

    /* ========== VALIDATE PHONE NUMBER ========== */
    const countryCode = document.getElementById('country-code').value;
    const phoneVal = document.getElementById('customer-phone').value.trim();
    const phoneError = document.getElementById('customer-phone-error');
    
    // Check if country is selected
    if (!countryCode) {
        phoneError.textContent = 'Please select your country.';
        document.getElementById('country-code').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
    }
    
    // Check if phone number is entered
    if (!phoneVal) {
        phoneError.textContent = 'Please enter your phone number.';
        document.getElementById('customer-phone').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
    }
    
    // Remove spaces, dashes, parentheses from phone number
    const cleanedPhone = phoneVal.replace(/[\s\-\(\)]/g, '');
    
    // Phone must be 7-15 digits only (no + sign since country code is separate)
    const phoneRegex = /^[0-9]{7,15}$/;
    
    if (!phoneRegex.test(cleanedPhone)) {
        phoneError.textContent = 'Invalid phone number. Enter 7-15 digits (no country code).';
        document.getElementById('customer-phone').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
    }
    
    phoneError.textContent = '';

    /* ========== VALIDATE PICKUP DATE (IF PICKUP METHOD) ========== */
    if(currentFulfillment === 'pickup'){
        if(!validatePickupDate()){
            // Scroll to pickup date field
            document.getElementById('pickup-date').scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }
    }
    
    /* ========== VALIDATE DELIVERY ADDRESS (IF DELIVERY METHOD) ========== */
    if(currentFulfillment === 'delivery'){
        if(!validateDeliveryAddress()){
            // Scroll to delivery address field
            document.getElementById('delivery-address').scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }
    }

    let cardDetails = null;

    /* ========== VALIDATE CREDIT CARD (IF NEW CARD) ========== */
    if(method === 'Credit Card' && savedCardId === 'new'){
        // Get card input values
        const cardName = document.getElementById('card-name').value.trim();
        const num = document.getElementById('card-number').value.replace(/\D/g, '');
        const exp = document.getElementById('card-exp').value.trim();
        const cvv = document.getElementById('card-cvv').value.trim();

        /* Validation 1: Check cardholder name */
        if(!cardName){
            section.classList.add('shake');
            errorMsg.innerText = 'Please enter the name on card.';
            setTimeout(function(){ section.classList.remove('shake'); }, 400);
            return;
        }

        /* Validation 2: Check card number (must be Visa/Mastercard and pass Luhn) */
        if((!num.startsWith('4') && !num.startsWith('5')) || !validateLuhn(num)){
            section.classList.add('shake');
            errorMsg.innerText = 'Please provide a valid VISA or Mastercard.';
            setTimeout(function(){ section.classList.remove('shake'); }, 400);
            return;
        }

        /* Validation 3: Check expiry date format (MM/YY) */
        if(!/^\d{2}\/\d{2}$/.test(exp)){
            section.classList.add('shake');
            errorMsg.innerText = 'Please enter expiry date as MM/YY.';
            setTimeout(function(){ section.classList.remove('shake'); }, 400);
            return;
        }

        /* Validation 4: Check CVV (3 or 4 digits) */
        if(!/^\d{3,4}$/.test(cvv)){
            section.classList.add('shake');
            errorMsg.innerText = 'Please enter a valid CVV.';
            setTimeout(function(){ section.classList.remove('shake'); }, 400);
            return;
        }

        /* All validations passed - prepare card details */
        cardDetails = {
            name: cardName,
            number: num,
            exp: exp,
            cvv: cvv,
            brand: detectCardBrand(num),
            last4: num.slice(-4) // Last 4 digits for saving
        };

        /* Save card if checkbox is checked */
        if(document.getElementById('save-card-checkbox').checked){
            saveCardToLocalStorage(cardDetails);
            loadSavedCards(); // Refresh saved cards dropdown
        }
    }

    /* ========== DISABLE BUTTON AND SHOW PROCESSING STATE ========== */
    btn.disabled = true;
    btn.innerHTML = 'Processing...';

    /* ========== GET PICKUP DATE OR DELIVERY ADDRESS ========== */
    let selectedDate = '';
    let fulfillmentDetails = '';
    
    if(currentFulfillment === 'pickup'){
        selectedDate = document.getElementById('pickup-date').value || 'Not selected';
        fulfillmentDetails = 'Pickup Date: ' + selectedDate + ' at 62 Race Course Rd, S218568';
    } else {
        selectedDate = document.getElementById('delivery-address').value || 'Address not provided';
        fulfillmentDetails = 'Delivery Address: ' + selectedDate;
    }

    /* ========== PREPARE PAYMENT PAYLOAD ========== */
    // Get cart and ensure images are included
    const cartRaw = JSON.parse(localStorage.getItem('cart') || '[]');
    
    // Enhance cart items to ensure all fields are present
    const cartWithImages = cartRaw.map(item => ({
        id: item.id,
        name: item.name,
        sku: item.sku || '',
        price: item.price,
        quantity: item.quantity,
        image: item.image || '/static/product_images_v2/placeholder.png'
    }));
    
    const payload = {
        cart: cartWithImages,
        total_amount: parseFloat(document.getElementById('summary-total').innerText.replace('S$', '')),
        fulfillment_method: currentFulfillment,
        fulfillment_details: fulfillmentDetails,
        payment_method: method,
        customer_phone: document.getElementById('country-code').value + ' ' + document.getElementById('customer-phone').value.trim()
    };

    /* ========== SUBMIT PAYMENT TO SERVER ========== */
    try{
        // Send POST request to backend
        const res = await fetch('/process-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}' // CSRF protection token
            },
            body: JSON.stringify(payload)
        });
        
        // Parse JSON response
        const result = await res.json();

        if(result.success){
            /* ========== PAYMENT SUCCESSFUL ========== */
            
            // Prepare order data for success page
            const cart = JSON.parse(localStorage.getItem('cart'));
            const subtotal = parseFloat(document.getElementById('summary-subtotal').innerText.replace('S$', ''));
            const shippingText = document.getElementById('summary-shipping').innerText;
            const shipping = shippingText === 'FREE' ? 0 : parseFloat(shippingText.replace('S$', ''));
            const total = parseFloat(document.getElementById('summary-total').innerText.replace('S$', ''));
            
            var orderData = {
                cart: cart,
                subtotal: subtotal,
                shipping: shipping,
                total: total,
                payment_method: method
            };
            
            // Save order data to sessionStorage (for success page)
            sessionStorage.setItem('last_order', JSON.stringify(orderData));
            
            // Clear cart from localStorage (order complete)
            localStorage.removeItem('cart');
            
            // Redirect to success page with fulfillment details
            window.location.href = '/order-success?method=' + currentFulfillment + '&date=' + encodeURIComponent(selectedDate);
        } else {
            /* ========== PAYMENT FAILED ========== */
            alert(result.message);
            
            // Re-enable button
            btn.disabled = false;
            btn.innerHTML = 'CONFIRM!';
        }
    } catch(err){
        /* ========== ERROR HANDLING ========== */
        console.error(err);
        alert('Something went wrong. Please try again.');
        
        // Re-enable button
        btn.disabled = false;
        btn.innerHTML = 'CONFIRM!';
    }
}

/* ========== PICKUP DATE VALIDATION ========== */
/* Validates that pickup date is today or in the future (no past dates allowed) */
function validatePickupDate() {
    const pickupDateInput = document.getElementById('pickup-date');
    const errorSpan = document.getElementById('pickup-date-error');
    const today = new Date().toISOString().split('T')[0];
    
    if (!pickupDateInput.value) {
        // No date selected
        pickupDateInput.classList.add('input-error');
        errorSpan.textContent = 'Please select a pickup date.';
        return false;
    }
    
    if (pickupDateInput.value < today) {
        // Past date selected
        pickupDateInput.classList.add('input-error');
        errorSpan.textContent = 'Pickup date cannot be in the past.';
        return false;
    }
    
    // Valid date
    pickupDateInput.classList.remove('input-error');
    errorSpan.textContent = '';
    return true;
}

/* ========== DELIVERY ADDRESS VALIDATION ========== */
/* Validates that delivery address contains required components for a proper address */
function validateDeliveryAddress() {
    const addressInput = document.getElementById('delivery-address');
    const errorSpan = document.getElementById('delivery-address-error');
    const address = addressInput.value.trim();
    
    // Check if address is empty
    if (!address) {
        addressInput.classList.add('input-error');
        errorSpan.textContent = 'Please enter a delivery address.';
        return false;
    }
    
    // Minimum length check (proper addresses should be at least 20 characters)
    if (address.length < 20) {
        addressInput.classList.add('input-error');
        errorSpan.textContent = 'Address is too short. Please provide a complete address.';
        return false;
    }
    
    // Check for digits (postal/zip codes, block/unit numbers)
    const hasDigits = /\d/.test(address);
    if (!hasDigits) {
        addressInput.classList.add('input-error');
        errorSpan.textContent = 'Address must include numbers (postal code, block, or unit number).';
        return false;
    }
    
    // Check for common address components using flexible patterns
    const hasStreetOrBlock = /\b(street|st|road|rd|avenue|ave|blk|block|drive|dr|lane|ln|way)\b/i.test(address);
    const hasPostalCode = /\b\d{5,6}\b/.test(address); // 5-6 digit postal/zip codes
    
    // Singapore specific patterns
    const isSingapore = /singapore|sg\b/i.test(address);
    
    if (isSingapore) {
        // Singapore address validation
        if (!hasPostalCode) {
            addressInput.classList.add('input-error');
            errorSpan.textContent = 'Singapore address must include a 6-digit postal code.';
            return false;
        }
    } else {
        // International address validation - should have country name
        const hasCountry = /\b[A-Z][a-z]+(?:\s+[A-Z][a-z]+)*\s*$/i.test(address.trim());
        
        if (!hasCountry) {
            addressInput.classList.add('input-error');
            errorSpan.textContent = 'For international delivery, please include the country name at the end.';
            return false;
        }
    }
    
    // Check that address has at least 2 commas or line breaks (separating different parts)
    const separators = (address.match(/[,\n]/g) || []).length;
    if (separators < 1) {
        addressInput.classList.add('input-error');
        errorSpan.textContent = 'Please separate address components with commas (e.g., street, unit, postal code).';
        return false;
    }
    
    // Valid address
    addressInput.classList.remove('input-error');
    errorSpan.textContent = '';
    return true;
}

/* ========== PAGE LOAD INITIALIZATION ========== */
/* Runs when page finishes loading */
document.addEventListener('DOMContentLoaded', function(){
    loadCheckoutCart();  // Load cart items and calculate totals
    loadSavedCards();    // Load saved payment cards
    updateCartBadge();   // Update cart badge on load
    
    // Initialize pickup date with today's date (default)
    const pickupDateInput = document.getElementById('pickup-date');
    const today = new Date().toISOString().split('T')[0];
    pickupDateInput.value = today;
    pickupDateInput.setAttribute('min', today); // Prevent past dates in date picker
    
    // Add validation on date change
    pickupDateInput.addEventListener('change', validatePickupDate);
    pickupDateInput.addEventListener('input', validatePickupDate);
    
    // Add validation on delivery address change
    const deliveryAddressInput = document.getElementById('delivery-address');
    deliveryAddressInput.addEventListener('blur', validateDeliveryAddress);
    deliveryAddressInput.addEventListener('input', function() {
        // Clear error on input to give immediate feedback
        if (deliveryAddressInput.value.trim().length > 0) {
            deliveryAddressInput.classList.remove('input-error');
            document.getElementById('delivery-address-error').textContent = '';
        }
    });
    
    // Add country search - user can type abbreviation (e.g., "US", "SG", "UK")
    const countrySelect = document.getElementById('country-code');
    let searchTimeout;
    let searchTerm = '';
    
    countrySelect.addEventListener('keypress', function(e) {
        // Prevent default select behavior
        e.preventDefault();
        
        // Build search term from typed characters
        searchTerm += e.key.toUpperCase();
        
        // Clear timeout if exists
        clearTimeout(searchTimeout);
        
        // Find matching country by abbreviation
        const options = Array.from(countrySelect.options);
        const match = options.find(opt => {
            const countryCode = opt.getAttribute('data-country');
            return countryCode && countryCode.startsWith(searchTerm);
        });
        
        if (match) {
            countrySelect.value = match.value;
        }
        
        // Reset search term after 1 second of no typing
        searchTimeout = setTimeout(() => {
            searchTerm = '';
        }, 1000);
    });
});

// Listen for cart updates from other tabs/windows
window.addEventListener('cartUpdated', updateCartBadge);

</script>

<!-- End of content block -->
{% endblock %}