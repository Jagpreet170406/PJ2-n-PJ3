{% extends "base.html" %}

{% block title %}Orders Management{% endblock %}

{% block content %}

<style>
/* PAGE BASE - matches dashboard.html */
html, body {
    background: #000000;
    margin: 0;
    padding: 0;
    overflow-x: hidden;
}

body {
    color: #fff;
    font-family: 'Inter', -apple-system, sans-serif;
}

/* WRAPPER */
.page-wrap {
    min-height: 100vh;
    padding-top: 100px;
    padding-bottom: 60px;
    position: relative;
    background: #000000;
}

.page-wrap::before {
    content: "";
    position: fixed;
    inset: 0;
    background: #000000;
    z-index: 0;
}

.page-wrap > * { position: relative; z-index: 1; }

/* HERO - matches dashboard */
.hero {
    max-width: 1400px;
    margin: 0 auto 30px;
    padding: 30px 20px;
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(20px);
    border-radius: 24px;
    border: 1px solid rgba(255, 255, 255, 0.15);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.hero h1 {
    font-weight: 900;
    font-size: 3.2rem;
    letter-spacing: -0.03em;
    margin: 0 0 10px;
    background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.7) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.hero p {
    color: rgba(255,255,255,0.85);
    font-size: 1.15rem;
    margin: 0;
}

/* MAIN CONTAINER */
.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 20px;
}

/* SECTION CARD - matches dashboard */
.section-card {
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255,255,255,0.14);
    border-radius: 24px;
    padding: 24px;
    backdrop-filter: blur(18px);
    box-shadow: 0 18px 60px rgba(0,0,0,0.35);
    margin-bottom: 24px;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.section-title {
    font-size: 1.2rem;
    font-weight: 800;
    color: rgba(255,255,255,0.92);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
}

.section-title::before {
    content: "";
    width: 4px;
    height: 22px;
    background: rgba(255,255,255,0.85);
    border-radius: 2px;
}

/* TABS - Workflow status tabs */
.tabs-container {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
    overflow-x: auto;
    padding-bottom: 8px;
}

.tabs-container::-webkit-scrollbar {
    height: 6px;
}

.tabs-container::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.05);
    border-radius: 3px;
}

.tabs-container::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.15);
    border-radius: 3px;
}

.tab-btn {
    padding: 12px 24px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.14);
    background: rgba(255,255,255,0.05);
    color: rgba(255,255,255,0.75);
    font-weight: 700;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    text-decoration: none;
    display: inline-block;
}

.tab-btn:hover {
    background: rgba(255,255,255,0.10);
    border-color: rgba(255,255,255,0.25);
    color: rgba(255,255,255,0.92);
}

.tab-btn.active {
    background: rgba(255,255,255,0.92);
    color: #111827;
    border-color: rgba(255,255,255,0.92);
}

/* SEARCH BAR */
.search-bar {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
    flex-wrap: wrap;
}

.search-input {
    flex: 1;
    min-width: 250px;
    padding: 12px 16px;
    background: rgba(0,0,0,0.30);
    border: 1px solid rgba(255,255,255,0.18);
    border-radius: 12px;
    color: rgba(255,255,255,0.92);
    font-size: 0.95rem;
}

.search-input::placeholder {
    color: rgba(255,255,255,0.45);
}

.search-input:focus {
    outline: none;
    border-color: rgba(255,255,255,0.35);
    box-shadow: 0 0 0 4px rgba(255,255,255,0.08);
}

.btn {
    padding: 12px 22px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    font-weight: 800;
    font-size: 0.95rem;
    transition: all 0.25s ease;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background: rgba(255,255,255,0.92);
    color: #111827;
    box-shadow: 0 10px 26px rgba(0,0,0,0.15);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 16px 45px rgba(0,0,0,0.25);
    background: #ffffff;
}

.btn-secondary {
    background: rgba(255,255,255,0.10);
    color: rgba(255,255,255,0.92);
    border: 1px solid rgba(255,255,255,0.18);
}

.btn-secondary:hover {
    background: rgba(255,255,255,0.16);
    border-color: rgba(255,255,255,0.28);
}

/* ORDERS GRID - Card layout instead of table */
.orders-grid {
    display: grid;
    gap: 20px;
}

.order-card {
    background: rgba(0,0,0,0.35);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 16px;
    padding: 20px;
    transition: all 0.25s ease;
}

.order-card:hover {
    border-color: rgba(255,255,255,0.22);
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    transform: translateY(-2px);
}

.order-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 16px;
    flex-wrap: wrap;
    gap: 12px;
}

.order-id {
    font-size: 1.3rem;
    font-weight: 800;
    color: rgba(255,255,255,0.95);
}

.order-status-badge {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.03em;
}

.status-incoming { background: rgba(59, 130, 246, 0.25); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.4); }
.status-in-progress { background: rgba(251, 191, 36, 0.25); color: #fcd34d; border: 1px solid rgba(251, 191, 36, 0.4); }
.status-awaiting-pickup { background: rgba(168, 85, 247, 0.25); color: #c4b5fd; border: 1px solid rgba(168, 85, 247, 0.4); }
.status-out-for-delivery { background: rgba(234, 179, 8, 0.25); color: #fde047; border: 1px solid rgba(234, 179, 8, 0.4); }
.status-completed { background: rgba(34, 197, 94, 0.25); color: #86efac; border: 1px solid rgba(34, 197, 94, 0.4); }
.status-issues { background: rgba(239, 68, 68, 0.25); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.4); }

.order-details {
    display: grid;
    gap: 10px;
    margin-bottom: 16px;
}

.order-detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.08);
}

.detail-label {
    color: rgba(255,255,255,0.65);
    font-size: 0.9rem;
}

.detail-value {
    color: rgba(255,255,255,0.95);
    font-weight: 600;
}

.order-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 16px;
}

.action-btn {
    flex: 1;
    min-width: 140px;
    padding: 10px 16px;
    border-radius: 10px;
    border: none;
    font-weight: 700;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
}

.action-btn-green {
    background: rgba(34, 197, 94, 0.20);
    color: #86efac;
    border: 1px solid rgba(34, 197, 94, 0.35);
}

.action-btn-green:hover {
    background: rgba(34, 197, 94, 0.30);
    border-color: rgba(34, 197, 94, 0.5);
    transform: translateY(-1px);
}

.action-btn-yellow {
    background: rgba(251, 191, 36, 0.20);
    color: #fcd34d;
    border: 1px solid rgba(251, 191, 36, 0.35);
}

.action-btn-yellow:hover {
    background: rgba(251, 191, 36, 0.30);
    border-color: rgba(251, 191, 36, 0.5);
    transform: translateY(-1px);
}

.action-btn-red {
    background: rgba(239, 68, 68, 0.20);
    color: #fca5a5;
    border: 1px solid rgba(239, 68, 68, 0.35);
}

.action-btn-red:hover {
    background: rgba(239, 68, 68, 0.30);
    border-color: rgba(239, 68, 68, 0.5);
    transform: translateY(-1px);
}

/* EMPTY STATE */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: rgba(255,255,255,0.6);
}

.empty-state h3 {
    font-size: 1.5rem;
    margin-bottom: 12px;
    color: rgba(255,255,255,0.8);
}

/* PAGINATION */
.pagination {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 32px;
    flex-wrap: wrap;
}

.pagination a, .pagination span {
    padding: 10px 16px;
    border-radius: 10px;
    background: rgba(255,255,255,0.08);
    color: rgba(255,255,255,0.75);
    text-decoration: none;
    border: 1px solid rgba(255,255,255,0.12);
    transition: all 0.2s;
    font-weight: 600;
}

.pagination a:hover {
    background: rgba(255,255,255,0.14);
    border-color: rgba(255,255,255,0.22);
    color: rgba(255,255,255,0.92);
}

.pagination span.active {
    background: rgba(255,255,255,0.92);
    color: #111827;
    border-color: rgba(255,255,255,0.92);
}

/* CONFIRM MODAL */
.confirm-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(8px);
    z-index: 9999;
    align-items: center;
    justify-content: center;
}

.confirm-modal.active {
    display: flex;
}

.confirm-modal-content {
    background: rgba(17, 24, 39, 0.95);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 20px;
    padding: 32px;
    max-width: 450px;
    width: 90%;
    text-align: center;
    box-shadow: 0 25px 60px rgba(0,0,0,0.5);
}

.confirm-modal-icon {
    font-size: 3.5rem;
    margin-bottom: 16px;
}

.confirm-modal-content h3 {
    font-size: 1.5rem;
    margin-bottom: 12px;
    font-weight: 800;
}

.confirm-modal-content h3.success { color: #86efac; }
.confirm-modal-content h3.warning { color: #fcd34d; }
.confirm-modal-content h3.danger { color: #fca5a5; }

.confirm-modal-content p {
    color: rgba(255,255,255,0.75);
    margin-bottom: 24px;
    line-height: 1.6;
}

.confirm-modal-actions {
    display: flex;
    gap: 12px;
}

.confirm-cancel-btn {
    flex: 1;
    padding: 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.18);
    background: rgba(255,255,255,0.08);
    color: rgba(255,255,255,0.85);
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
}

.confirm-cancel-btn:hover {
    background: rgba(255,255,255,0.14);
    border-color: rgba(255,255,255,0.28);
}

.confirm-go-btn-green, .confirm-go-btn-yellow, .confirm-go-btn-red {
    flex: 1;
    padding: 12px;
    border-radius: 12px;
    border: none;
    font-weight: 800;
    cursor: pointer;
    transition: all 0.2s;
}

.confirm-go-btn-green {
    background: rgba(34, 197, 94, 0.25);
    color: #86efac;
    border: 1px solid rgba(34, 197, 94, 0.4);
}

.confirm-go-btn-green:hover {
    background: rgba(34, 197, 94, 0.35);
    border-color: rgba(34, 197, 94, 0.6);
}

.confirm-go-btn-yellow {
    background: rgba(251, 191, 36, 0.25);
    color: #fcd34d;
    border: 1px solid rgba(251, 191, 36, 0.4);
}

.confirm-go-btn-yellow:hover {
    background: rgba(251, 191, 36, 0.35);
    border-color: rgba(251, 191, 36, 0.6);
}

.confirm-go-btn-red {
    background: rgba(239, 68, 68, 0.25);
    color: #fca5a5;
    border: 1px solid rgba(239, 68, 68, 0.4);
}

.confirm-go-btn-red:hover {
    background: rgba(239, 68, 68, 0.35);
    border-color: rgba(239, 68, 68, 0.6);
}

/* BIG NOTIFICATION */
.big-notification {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.8);
    background: rgba(239, 68, 68, 0.95);
    color: #fff;
    padding: 40px 60px;
    border-radius: 20px;
    font-size: 1.8rem;
    font-weight: 900;
    text-align: center;
    z-index: 10000;
    box-shadow: 0 30px 70px rgba(0,0,0,0.6);
    backdrop-filter: blur(12px);
    border: 2px solid rgba(255,255,255,0.25);
    opacity: 0;
    transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.big-notification.success {
    background: rgba(34, 197, 94, 0.95);
    border-color: rgba(134, 239, 172, 0.4);
}

.big-notification.warning {
    background: rgba(251, 191, 36, 0.95);
    border-color: rgba(252, 211, 77, 0.4);
}

.big-notification.show {
    display: block;
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
}

.big-notification.hide {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.8);
}

@media (max-width: 768px) {
    .hero h1 { font-size: 2.2rem; }
    .order-card-header { flex-direction: column; align-items: flex-start; }
    .action-btn { min-width: 100%; }
    .big-notification { font-size: 1.3rem; padding: 30px 40px; }
}
</style>

<div class="page-wrap">
    <!-- Hero -->
    <div class="hero">
        <h1>Orders Management</h1>
        <p>Track and manage customer orders through the workflow</p>
    </div>

    <!-- Main Container -->
    <div class="container">
        <div class="section-card">
            <!-- Tabs for workflow stages -->
            <div class="tabs-container">
                <a href="{{ url_for('orders', tab='Incoming') }}" 
                   class="tab-btn {% if active_tab == 'Incoming' %}active{% endif %}">
                    Incoming ({{ counts.get('Incoming', 0) }})
                </a>
                <a href="{{ url_for('orders', tab='In Progress') }}" 
                   class="tab-btn {% if active_tab == 'In Progress' %}active{% endif %}">
                    In Progress ({{ counts.get('In Progress', 0) }})
                </a>
                <a href="{{ url_for('orders', tab='Awaiting Pickup') }}" 
                   class="tab-btn {% if active_tab == 'Awaiting Pickup' %}active{% endif %}">
                    Awaiting Pickup ({{ counts.get('Awaiting Pickup', 0) }})
                </a>
                <a href="{{ url_for('orders', tab='Out for Delivery') }}" 
                   class="tab-btn {% if active_tab == 'Out for Delivery' %}active{% endif %}">
                    Out for Delivery ({{ counts.get('Out for Delivery', 0) }})
                </a>
                <a href="{{ url_for('orders', tab='Completed') }}" 
                   class="tab-btn {% if active_tab == 'Completed' %}active{% endif %}">
                    Completed ({{ counts.get('Completed', 0) }})
                </a>
                <a href="{{ url_for('orders', tab='Issues') }}" 
                   class="tab-btn {% if active_tab == 'Issues' %}active{% endif %}">
                    Issues ({{ counts.get('Issues', 0) }})
                </a>
            </div>

            <!-- Search Bar -->
            <div class="search-bar">
                <form method="get" action="{{ url_for('orders') }}" style="display: flex; gap: 12px; flex: 1;">
                    <input type="hidden" name="tab" value="{{ active_tab }}">
                    <input 
                        type="text" 
                        name="search" 
                        class="search-input" 
                        placeholder="Search by Order ID, Customer Email, or Payment Type..."
                        value="{{ search_query or '' }}"
                    >
                    <button type="submit" class="btn btn-primary">Search</button>
                    {% if search_query %}
                    <a href="{{ url_for('orders', tab=active_tab) }}" class="btn btn-secondary">Clear</a>
                    {% endif %}
                </form>
            </div>

            <!-- Orders Display -->
            {% if orders_list %}
            <div class="orders-grid">
                {% for order in orders_list %}
                <div class="order-card">
                    <!-- Header -->
                    <div class="order-card-header">
                        <div class="order-id">Order #{{ order['id'] }}</div>
                        <span class="order-status-badge status-{{ order['status'].lower().replace(' ', '-') }}">
                            {{ order['status'] }}
                        </span>
                    </div>

                    <!-- Details -->
                    <div class="order-details">
                        <div class="order-detail-row">
                            <span class="detail-label">Customer Phone</span>
                            <span class="detail-value">
                                {% if order['customer_phone'] %}
                                    <a href="tel:{{ order['customer_phone'] }}" 
                                       style="color: #60a5fa; text-decoration: none;">
                                        {{ order['customer_phone'] }}
                                    </a>
                                {% else %}
                                    N/A
                                {% endif %}
                            </span>
                        </div>
                        <div class="order-detail-row">
                            <span class="detail-label">Amount</span>
                            <span class="detail-value">S${{ "%.2f"|format(order['amount'] or 0) }}</span>
                        </div>
                        <div class="order-detail-row">
                            <span class="detail-label">Payment</span>
                            <span class="detail-value">{{ order['payment_type'] or 'N/A' }}</span>
                        </div>
                        <div class="order-detail-row">
                            <span class="detail-label">Fulfillment</span>
                            <span class="detail-value">
                                {{ order['fulfillment_method']|title if order['fulfillment_method'] else 'N/A' }}
                            </span>
                        </div>
                        {% if order['fulfillment_details'] %}
                        <div class="order-detail-row">
                            <span class="detail-label">Details</span>
                            <span class="detail-value">{{ order['fulfillment_details'] }}</span>
                        </div>
                        {% endif %}
                        <div class="order-detail-row">
                            <span class="detail-label">Date</span>
                            <span class="detail-value">{{ order['timestamp'] }}</span>
                        </div>
                    </div>

                    <!-- Order Items Section - Products to pack -->
                    {% if order['order_items'] %}
                    <div class="order-items-section" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.12);">
                        <div style="font-size: 0.85rem; font-weight: 800; color: rgba(255,255,255,0.70); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px;">
                            üì¶ Items to Pack
                        </div>
                        {% for item in order['order_items'] %}
                        <div class="order-item-row" style="display: flex; align-items: center; gap: 12px; padding: 10px; background: rgba(0,0,0,0.25); border-radius: 8px; margin-bottom: 8px;">
                            <!-- Product Image -->
                            <img src="{{ item['image_url'] or '/static/product_images_v2/placeholder.png' }}" 
                                 alt="{{ item['product_name'] }}"
                                 style="width: 50px; height: 50px; object-fit: contain; border-radius: 6px; background: rgba(255,255,255,0.10); padding: 4px;">
                            
                            <!-- Product Details -->
                            <div style="flex: 1;">
                                <div style="font-weight: 700; color: rgba(255,255,255,0.92); margin-bottom: 4px;">
                                    {{ item['product_name'] }}
                                </div>
                                <div style="font-size: 0.8rem; color: rgba(255,255,255,0.55);">
                                    {% if item['product_sku'] %}SKU: {{ item['product_sku'] }} ‚Ä¢ {% endif %}
                                    Qty: {{ item['quantity'] }} √ó S${{ "%.2f"|format(item['unit_price']) }}
                                </div>
                            </div>
                            
                            <!-- Item Subtotal -->
                            <div style="font-weight: 800; color: rgba(255,255,255,0.92); font-size: 1rem;">
                                S${{ "%.2f"|format(item['quantity'] * item['unit_price']) }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Actions based on current status -->
                    <div class="order-actions">
                        {% if order['status'] == 'Incoming' %}
                            <button class="action-btn action-btn-green" 
                                    onclick="updateOrderStatus({{ order['id'] }}, 'In Progress')">
                                üì¶ Start Packing
                            </button>
                            <button class="action-btn action-btn-red" 
                                    onclick="updateOrderStatus({{ order['id'] }}, 'Issues')">
                                ‚ö†Ô∏è Flag Issue
                            </button>
                            <button class="action-btn action-btn-red" 
                                    onclick="cancelOrder({{ order['id'] }})">
                                üóëÔ∏è Cancel
                            </button>

                        {% elif order['status'] == 'In Progress' %}
                            {% if order['fulfillment_method'] == 'pickup' %}
                                <button class="action-btn action-btn-green" 
                                        onclick="updateOrderStatus({{ order['id'] }}, 'Awaiting Pickup')">
                                    üè™ Mark Ready for Pickup
                                </button>
                            {% else %}
                                <button class="action-btn action-btn-yellow" 
                                        onclick="updateOrderStatus({{ order['id'] }}, 'Out for Delivery')">
                                    üöö Out for Delivery
                                </button>
                            {% endif %}
                            <button class="action-btn action-btn-red" 
                                    onclick="updateOrderStatus({{ order['id'] }}, 'Issues')">
                                ‚ö†Ô∏è Flag Issue
                            </button>

                        {% elif order['status'] == 'Awaiting Pickup' %}
                            <button class="action-btn action-btn-green" 
                                    onclick="notifyAndComplete({{ order['id'] }}, '{{ order['customer_phone'] or '' }}')">
                                ‚úÖ Customer Picked Up
                            </button>
                            <button class="action-btn action-btn-red" 
                                    onclick="updateOrderStatus({{ order['id'] }}, 'Issues')">
                                ‚ö†Ô∏è Flag Issue
                            </button>

                        {% elif order['status'] == 'Out for Delivery' %}
                            <button class="action-btn action-btn-green" 
                                    onclick="updateOrderStatus({{ order['id'] }}, 'Completed')">
                                ‚úÖ Mark Delivered
                            </button>
                            <button class="action-btn action-btn-red" 
                                    onclick="updateOrderStatus({{ order['id'] }}, 'Issues')">
                                ‚ö†Ô∏è Flag Issue
                            </button>

                        {% elif order['status'] == 'Issues' %}
                            <button class="action-btn action-btn-yellow" 
                                    onclick="updateOrderStatus({{ order['id'] }}, 'Incoming')">
                                üîÑ Move to Incoming
                            </button>
                            <button class="action-btn action-btn-red" 
                                    onclick="cancelOrder({{ order['id'] }})">
                                üóëÔ∏è Cancel Order
                            </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if total_pages > 1 %}
            <div class="pagination">
                {% if current_page > 1 %}
                    <a href="{{ url_for('orders', tab=active_tab, page=current_page-1, search=search_query) }}">‚Üê Prev</a>
                {% endif %}
                {% for p in range(1, total_pages + 1) %}
                    {% if p == current_page %}
                        <span class="active">{{ p }}</span>
                    {% elif p == 1 or p == total_pages or (p >= current_page - 2 and p <= current_page + 2) %}
                        <a href="{{ url_for('orders', tab=active_tab, page=p, search=search_query) }}">{{ p }}</a>
                    {% elif p == current_page - 3 or p == current_page + 3 %}
                        <span>...</span>
                    {% endif %}
                {% endfor %}
                {% if current_page < total_pages %}
                    <a href="{{ url_for('orders', tab=active_tab, page=current_page+1, search=search_query) }}">Next ‚Üí</a>
                {% endif %}
            </div>
            {% endif %}

            {% else %}
            <!-- Empty State -->
            <div class="empty-state">
                <h3>No {{ active_tab }} Orders</h3>
                <p>There are currently no orders in the {{ active_tab }} stage.</p>
                {% if search_query %}
                <p style="margin-top: 1rem;">
                    <a href="{{ url_for('orders', tab=active_tab) }}" class="btn btn-secondary">Clear Search</a>
                </p>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- CONFIRM MODAL -->
<div class="confirm-modal" id="confirmModal">
    <div class="confirm-modal-content">
        <div class="confirm-modal-icon" id="confirmIcon">‚ö†Ô∏è</div>
        <h3 id="confirmTitle" class="warning">Confirm Action</h3>
        <p id="confirmMessage">Are you sure?</p>
        <div class="confirm-modal-actions">
            <button class="confirm-cancel-btn" onclick="closeConfirmModal()">Cancel</button>
            <button id="confirmGoBtn">Confirm</button>
        </div>
    </div>
</div>

<!-- BIG NOTIFICATION -->
<div id="bigNotification" class="big-notification"></div>

<script>
// ============================================================
// BIG NOTIFICATION
// ============================================================
function showBigNotification(message, type) {
    const el = document.getElementById('bigNotification');
    let icon = '‚úñ', cls = 'big-notification';
    if (type === 'success') { icon = '‚úì'; cls = 'big-notification success'; }
    else if (type === 'warning') { icon = '‚úé'; cls = 'big-notification warning'; }
    el.innerHTML = `<span style="display:block;font-size:2.5rem;margin-bottom:10px;">${icon}</span>${message}`;
    el.className = cls;
    void el.offsetWidth;
    el.classList.add('show');
    setTimeout(() => {
        el.classList.remove('show');
        el.classList.add('hide');
        setTimeout(() => { el.classList.remove('hide'); el.className = 'big-notification'; }, 400);
    }, 2200);
}

// ============================================================
// CONFIRM MODAL
// ============================================================
function closeConfirmModal() {
    document.getElementById('confirmModal').classList.remove('active');
    document.getElementById('confirmGoBtn').onclick = null;
}

document.getElementById('confirmModal').addEventListener('click', function(e) {
    if (e.target === this) closeConfirmModal();
});

function showConfirmModal({ icon, titleText, titleClass, message, btnText, btnClass, onConfirm }) {
    document.getElementById('confirmIcon').textContent     = icon;
    document.getElementById('confirmTitle').textContent    = titleText;
    document.getElementById('confirmTitle').className      = titleClass;
    document.getElementById('confirmMessage').textContent  = message;
    const goBtn = document.getElementById('confirmGoBtn');
    goBtn.textContent = btnText;
    goBtn.className   = btnClass;
    goBtn.onclick = async () => {
        closeConfirmModal();
        await onConfirm();
    };
    document.getElementById('confirmModal').classList.add('active');
}

// ============================================================
// STATUS CONFIGS - REMOVED EMAIL NOTIFICATION REFERENCES
// ============================================================
const STATUS_CONFIG = {
    'In Progress':      { icon: 'üì¶', titleText: 'Start Packing?',    titleClass: 'success', btnText: 'Start Packing',    btnClass: 'confirm-go-btn-green',  notifMsg: 'PACKING STARTED',  notifType: 'success' },
    'Awaiting Pickup':  { icon: 'üè™', titleText: 'Done Packing?',     titleClass: 'success', btnText: 'Mark Ready',        btnClass: 'confirm-go-btn-green',  notifMsg: 'ORDER READY!',     notifType: 'success' },
    'Out for Delivery': { icon: 'üöö', titleText: 'Done Packing?',     titleClass: 'warning', btnText: 'Out for Delivery',  btnClass: 'confirm-go-btn-yellow', notifMsg: 'OUT FOR DELIVERY', notifType: 'warning' },
    'Completed':        { icon: 'üéâ', titleText: 'Mark Completed?',   titleClass: 'success', btnText: 'Mark Completed',    btnClass: 'confirm-go-btn-green',  notifMsg: 'ORDER COMPLETED!', notifType: 'success' },
    'Issues':           { icon: '‚ö†Ô∏è', titleText: 'Flag as Issue?',    titleClass: 'danger',  btnText: 'Flag Issue',        btnClass: 'confirm-go-btn-red',    notifMsg: 'FLAGGED AS ISSUE', notifType: 'error'   },
    'Incoming':         { icon: 'üîÑ', titleText: 'Restart Order?',    titleClass: 'warning', btnText: 'Restart',           btnClass: 'confirm-go-btn-yellow', notifMsg: 'ORDER RESTARTED',  notifType: 'warning' },
};

function tabUrl(tab) { return `/orders?tab=${encodeURIComponent(tab)}`; }

// ============================================================
// UPDATE ORDER STATUS - NO EMAIL NOTIFICATION
// ============================================================
function updateOrderStatus(orderId, newStatus) {
    const cfg = STATUS_CONFIG[newStatus] || {
        icon: '‚ùì', titleText: `Move to ${newStatus}?`, titleClass: 'warning',
        btnText: 'Confirm', btnClass: 'confirm-go-btn-yellow',
        notifMsg: `MOVED TO ${newStatus.toUpperCase()}`, notifType: 'warning'
    };
    showConfirmModal({
        icon: cfg.icon, titleText: cfg.titleText, titleClass: cfg.titleClass,
        message: `Order #${orderId} will be moved to "${newStatus}".`,
        btnText: cfg.btnText, btnClass: cfg.btnClass,
        onConfirm: async () => {
            try {
                const resp = await fetch(`/api/update-order-status/${orderId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                const result = await resp.json();
                if (result.success) {
                    showBigNotification(cfg.notifMsg, cfg.notifType);
                    setTimeout(() => { window.location.href = tabUrl(newStatus); }, 1800);
                } else {
                    showBigNotification('FAILED: ' + (result.message || 'Unknown error'), 'error');
                }
            } catch (err) {
                console.error(err);
                showBigNotification('NETWORK ERROR', 'error');
            }
        }
    });
}

// ============================================================
// PICKED UP ‚Äî mark completed (no email, phone-based communication)
// ============================================================
function notifyAndComplete(orderId, customerPhone) {
    showConfirmModal({
        icon: '‚úÖ', titleText: 'Customer Picked Up?', titleClass: 'success',
        message: `Confirm Order #${orderId} has been collected by the customer.`,
        btnText: 'Confirm Pickup', btnClass: 'confirm-go-btn-green',
        onConfirm: async () => {
            try {
                const resp = await fetch(`/api/update-order-status/${orderId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'Completed' })
                });
                const result = await resp.json();
                if (result.success) {
                    showBigNotification('ORDER COMPLETED!', 'success');
                    setTimeout(() => { window.location.href = tabUrl('Completed'); }, 1800);
                } else {
                    showBigNotification('FAILED: ' + (result.message || ''), 'error');
                }
            } catch (err) {
                console.error(err);
                showBigNotification('NETWORK ERROR', 'error');
            }
        }
    });
}

// ============================================================
// CANCEL ORDER
// ============================================================
function cancelOrder(orderId) {
    showConfirmModal({
        icon: 'üóëÔ∏è', titleText: 'Cancel Order?', titleClass: 'danger',
        message: `Order #${orderId} will be permanently cancelled. This cannot be undone.`,
        btnText: 'Cancel Order', btnClass: 'confirm-go-btn-red',
        onConfirm: async () => {
            try {
                const resp = await fetch(`/api/cancel-order/${orderId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await resp.json();
                if (result.success) {
                    showBigNotification('ORDER CANCELLED', 'error');
                    setTimeout(() => { window.location.href = tabUrl('Incoming'); }, 1800);
                } else {
                    showBigNotification('CANCEL FAILED: ' + (result.message || ''), 'error');
                }
            } catch (err) {
                console.error(err);
                showBigNotification('NETWORK ERROR', 'error');
            }
        }
    });
}
</script>

{% endblock %}