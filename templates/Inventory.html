{% extends "base.html" %}

{% block title %}Inventory{% endblock %}

{% block content %}

<style>
body {
    font-family: Arial, sans-serif;
    background: #000;
    color: #fff;
    padding: 20px;
}

h1 {
    font-size: 28px;
    margin-bottom: 10px;
}

.controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.controls input, .controls select, .controls button {
    padding: 8px 12px;
    border-radius: 10px;
    border: 1px solid #333;
    background: #111;
    color: #fff;
}

.controls button {
    background: #0066ff;
    border: none;
    cursor: pointer;
    font-weight: bold;
}

.controls button:hover {
    background: #0052cc;
}

.grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
}

.card {
    background: #111;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #222;
    transition: 0.2s;
    position: relative;
}

.card:hover {
    background: #1f1f1f;
}

.img-placeholder {
    background: #1a1a1a;
    height: 150px;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #777;
    margin-bottom: 8px;
}

.stock {
    font-size: 13px;
    margin-top: 5px;
}

.low {
    color: orange;
}

.critical {
    color: red;
}

.card-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
}

.card-actions button {
    flex: 1;
    padding: 6px 10px;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    font-size: 12px;
}

.edit-btn {
    background: #28a745;
    color: white;
}

.edit-btn:hover {
    background: #218838;
}

.delete-btn {
    background: #dc3545;
    color: white;
}

.delete-btn:hover {
    background: #c82333;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: #1a1a1a;
    padding: 25px;
    border-radius: 15px;
    border: 1px solid #333;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-content h2 {
    margin-top: 0;
    margin-bottom: 20px;
}

.modal-content label {
    display: block;
    margin-bottom: 5px;
    font-size: 14px;
    color: #aaa;
}

.modal-content input, .modal-content select {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 8px;
    border: 1px solid #333;
    background: #111;
    color: #fff;
    box-sizing: border-box;
}

.modal-content input.error, .modal-content select.error {
    border-color: #dc3545;
}

.error-message {
    color: #dc3545;
    font-size: 12px;
    margin-top: -10px;
    margin-bottom: 10px;
    display: none;
}

.error-message.show {
    display: block;
}

.modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.modal-actions button {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: bold;
}

.save-btn {
    background: #0066ff;
    color: white;
}

.save-btn:hover {
    background: #0052cc;
}

.save-btn:disabled {
    background: #555;
    cursor: not-allowed;
}

.cancel-btn {
    background: #555;
    color: white;
}

.cancel-btn:hover {
    background: #666;
}

.loading {
    text-align: center;
    padding: 50px;
    font-size: 18px;
    color: #777;
}

/* Pagination Styles */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 30px;
    padding: 20px;
}

.pagination button {
    padding: 8px 16px;
    background: #111;
    border: 1px solid #333;
    border-radius: 8px;
    color: #fff;
    cursor: pointer;
    font-weight: bold;
}

.pagination button:hover:not(:disabled) {
    background: #0066ff;
    border-color: #0066ff;
}

.pagination button:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

.pagination .page-info {
    color: #888;
    font-size: 14px;
}

.pagination .page-number {
    padding: 8px 16px;
    background: #0066ff;
    border: 1px solid #0066ff;
    border-radius: 8px;
    color: #fff;
    font-weight: bold;
}

/* BIG ASS NOTIFICATION */
.big-notification {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    background: linear-gradient(135deg, #dc3545 0%, #ff6b6b 100%);
    color: white;
    padding: 50px 70px;
    border-radius: 25px;
    font-size: 48px;
    font-weight: 900;
    text-align: center;
    z-index: 10000;
    box-shadow: 0 20px 60px rgba(220, 53, 69, 0.5);
    border: 4px solid #fff;
    opacity: 0;
    pointer-events: none;
}

.big-notification.success {
    background: linear-gradient(135deg, #28a745 0%, #5cb85c 100%);
    box-shadow: 0 20px 60px rgba(40, 167, 69, 0.5);
}

.big-notification.show {
    animation: bigPopIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
}

.big-notification.hide {
    animation: bigPopOut 0.4s ease-in forwards;
}

@keyframes bigPopIn {
    0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 0;
    }
    50% {
        transform: translate(-50%, -50%) scale(1.1);
    }
    100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
    }
}

@keyframes bigPopOut {
    0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
    }
    100% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 0;
    }
}

.notification-icon {
    font-size: 80px;
    display: block;
    margin-bottom: 20px;
}

/* Delete Confirmation Modal */
.delete-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}

.delete-modal.active {
    display: flex;
}

.delete-modal-content {
    background: #1a1a1a;
    padding: 30px;
    border-radius: 15px;
    border: 2px solid #dc3545;
    max-width: 450px;
    text-align: center;
}

.delete-modal-content h3 {
    color: #dc3545;
    font-size: 24px;
    margin-bottom: 15px;
}

.delete-modal-content p {
    color: #aaa;
    margin-bottom: 25px;
    line-height: 1.6;
}

.delete-modal-actions {
    display: flex;
    gap: 15px;
}

.delete-modal-actions button {
    flex: 1;
    padding: 12px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
}

.stats-bar {
    background: #111;
    border: 1px solid #222;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
}

.stat-item {
    flex: 1;
    min-width: 150px;
}

.stat-label {
    font-size: 12px;
    color: #888;
    text-transform: uppercase;
}

.stat-value {
    font-size: 24px;
    font-weight: bold;
    color: #4ade80;
    margin-top: 5px;
}
</style>

<div>
    <h1>Inventory Management</h1>
    
    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat-item">
            <div class="stat-label">Total Products</div>
            <div class="stat-value" id="totalProducts">0</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Total Stock</div>
            <div class="stat-value" id="totalStock">0</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Low Stock Items</div>
            <div class="stat-value" style="color: #f59e0b;" id="lowStockItems">0</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Critical Stock</div>
            <div class="stat-value" style="color: #dc3545;" id="criticalStockItems">0</div>
        </div>
    </div>
    
    <div class="controls">
        <input type="text" id="searchInput" placeholder="Search products...">
        <select id="sortSelect">
            <option value="">Sort by</option>
            <option value="name">Name (A‚ÄìZ)</option>
            <option value="stock">Stock (High ‚Üí Low)</option>
            <option value="price">Price (Low ‚Üí High)</option>
        </select>
        <select id="perPageSelect">
            <option value="12">12 per page</option>
            <option value="24" selected>24 per page</option>
            <option value="48">48 per page</option>
            <option value="96">96 per page</option>
        </select>
        <button id="addProductBtn">+ Add Product</button>
    </div>
    
    <div class="grid" id="productGrid">
        <div class="loading">Loading inventory...</div>
    </div>
    
    <!-- Pagination -->
    <div class="pagination" id="paginationControls" style="display: none;">
        <button id="firstPageBtn">‚èÆÔ∏è First</button>
        <button id="prevPageBtn">‚óÄÔ∏è Prev</button>
        <span class="page-number" id="currentPageDisplay">1</span>
        <span class="page-info" id="pageInfo">of 1</span>
        <button id="nextPageBtn">Next ‚ñ∂Ô∏è</button>
        <button id="lastPageBtn">Last ‚è≠Ô∏è</button>
    </div>
</div>

<!-- Modal for Add/Edit Product -->
<div class="modal" id="productModal">
    <div class="modal-content">
        <h2 id="modalTitle">Add Product</h2>
        <form id="productForm">
            <label for="productPartNo">Supplier Part Number</label>
            <input type="text" id="productPartNo" placeholder="e.g., SP-12345">
            <div class="error-message" id="errorPartNo"></div>
            
            <label for="productName">Product Name * (Min 3 chars)</label>
            <input type="text" id="productName" required minlength="3">
            <div class="error-message" id="errorName"></div>
            
            <label for="productCategory">Category *</label>
            <select id="productCategory" required>
                <option value="Lubricants">Lubricants</option>
                <option value="Engine Oil">Engine Oil</option>
                <option value="Transmission Oil">Transmission Oil</option>
                <option value="Brake Fluid">Brake Fluid</option>
                <option value="Coolant">Coolant</option>
                <option value="Parts">Parts</option>
                <option value="Accessories">Accessories</option>
                <option value="Other">Other</option>
            </select>
            <div class="error-message" id="errorCategory"></div>
            
            <label for="productStock">Stock Quantity * (Min 0)</label>
            <input type="number" id="productStock" required min="0" value="0">
            <div class="error-message" id="errorStock"></div>
            
            <label for="productPrice">Selling Price (SGD) * (Min 0.01)</label>
            <input type="number" id="productPrice" required min="0.01" step="0.01" value="0.00">
            <div class="error-message" id="errorPrice"></div>
            
            <label for="productImage">Image URL (optional)</label>
            <input type="text" id="productImage" placeholder="https://...">
            <div class="error-message" id="errorImage"></div>
            
            <div class="modal-actions">
                <button type="submit" class="save-btn" id="saveBtn">Save</button>
                <button type="button" class="cancel-btn" id="cancelBtn">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="delete-modal" id="deleteModal">
    <div class="delete-modal-content">
        <h3>‚ö†Ô∏è Confirm Deletion</h3>
        <p>Are you sure you want to delete <strong id="deleteProductName"></strong>?</p>
        <p style="font-size: 14px; color: #666;">This action cannot be undone.</p>
        <div class="delete-modal-actions">
            <button class="cancel-btn" id="cancelDeleteBtn">Cancel</button>
            <button class="delete-btn" id="confirmDeleteBtn">Delete Product</button>
        </div>
    </div>
</div>

<!-- BIG ASS NOTIFICATION -->
<div id="bigNotification" class="big-notification"></div>

<script>
let allProducts = [];
let filteredProducts = [];
let currentPage = 1;
let itemsPerPage = 24;
let editingId = null;
let deleteProductId = null;

// Grab elements
const searchInput = document.getElementById("searchInput");
const sortSelect = document.getElementById("sortSelect");
const perPageSelect = document.getElementById("perPageSelect");
const productGrid = document.getElementById("productGrid");
const addProductBtn = document.getElementById("addProductBtn");
const productModal = document.getElementById("productModal");
const productForm = document.getElementById("productForm");
const modalTitle = document.getElementById("modalTitle");
const cancelBtn = document.getElementById("cancelBtn");
const bigNotification = document.getElementById("bigNotification");
const deleteModal = document.getElementById("deleteModal");
const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");

// Pagination elements
const paginationControls = document.getElementById("paginationControls");
const firstPageBtn = document.getElementById("firstPageBtn");
const prevPageBtn = document.getElementById("prevPageBtn");
const nextPageBtn = document.getElementById("nextPageBtn");
const lastPageBtn = document.getElementById("lastPageBtn");
const currentPageDisplay = document.getElementById("currentPageDisplay");
const pageInfo = document.getElementById("pageInfo");

// Validation functions
function validateField(fieldId, errorId, validationFn, errorMsg) {
    const field = document.getElementById(fieldId);
    const error = document.getElementById(errorId);
    const isValid = validationFn(field.value);
    
    if (!isValid) {
        field.classList.add('error');
        error.textContent = errorMsg;
        error.classList.add('show');
    } else {
        field.classList.remove('error');
        error.classList.remove('show');
    }
    
    return isValid;
}

function validateForm() {
    const name = document.getElementById("productName").value.trim();
    const stock = parseInt(document.getElementById("productStock").value);
    const price = parseFloat(document.getElementById("productPrice").value);
    
    let isValid = true;
    
    // Validate Product Name (required, min 3 characters)
    if (!validateField('productName', 'errorName', 
        val => val.trim().length >= 3, 
        'Product name must be at least 3 characters')) {
        isValid = false;
    }
    
    // Validate Stock (required, >= 0)
    if (!validateField('productStock', 'errorStock', 
        val => !isNaN(val) && parseInt(val) >= 0, 
        'Stock must be 0 or greater')) {
        isValid = false;
    }
    
    // Validate Price (required, > 0)
    if (!validateField('productPrice', 'errorPrice', 
        val => !isNaN(val) && parseFloat(val) >= 0.01, 
        'Price must be at least 0.01')) {
        isValid = false;
    }
    
    // Validate Category (required)
    if (!validateField('productCategory', 'errorCategory', 
        val => val.trim().length > 0, 
        'Category is required')) {
        isValid = false;
    }
    
    return isValid;
}

// Clear validation errors
function clearValidationErrors() {
    document.querySelectorAll('.error-message').forEach(el => el.classList.remove('show'));
    document.querySelectorAll('input, select').forEach(el => el.classList.remove('error'));
}

// Show BIG ASS notification
function showBigNotification(message, isSuccess = false) {
    const icon = isSuccess ? '‚úì' : '‚úñ';
    bigNotification.innerHTML = `<span class="notification-icon">${icon}</span>${message}`;
    bigNotification.className = `big-notification ${isSuccess ? 'success' : ''}`;
    
    void bigNotification.offsetWidth;
    
    bigNotification.classList.add('show');
    
    setTimeout(() => {
        bigNotification.classList.remove('show');
        bigNotification.classList.add('hide');
        setTimeout(() => {
            bigNotification.classList.remove('hide');
            bigNotification.className = 'big-notification';
        }, 400);
    }, 2500);
}

// Update statistics
function updateStats() {
    const totalProducts = allProducts.length;
    const totalStock = allProducts.reduce((sum, p) => sum + p.qty, 0);
    const lowStockItems = allProducts.filter(p => p.qty > 60 && p.qty <= 80).length;
    const criticalStockItems = allProducts.filter(p => p.qty <= 60).length;
    
    document.getElementById('totalProducts').textContent = totalProducts;
    document.getElementById('totalStock').textContent = totalStock.toLocaleString();
    document.getElementById('lowStockItems').textContent = lowStockItems;
    document.getElementById('criticalStockItems').textContent = criticalStockItems;
}

// Load products from database
async function loadProducts() {
    try {
        const response = await fetch('/api/inventory');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        allProducts = data;
        updateStats();
        filterAndSortProducts();
    } catch (error) {
        console.error('Error loading products:', error);
        productGrid.innerHTML = '<div class="loading" style="color: red;">Error loading inventory. Please refresh.</div>';
        showBigNotification('FAILED TO LOAD INVENTORY');
    }
}

// Filter and sort products
function filterAndSortProducts() {
    const searchText = searchInput.value.toLowerCase();
    const sortType = sortSelect.value;
    
    // Filter products
    filteredProducts = allProducts.filter(p => 
        p.hem_name.toLowerCase().includes(searchText) ||
        (p.sup_part_no && p.sup_part_no.toLowerCase().includes(searchText))
    );
    
    // Sort products
    if (sortType === "name") {
        filteredProducts.sort((a, b) => a.hem_name.localeCompare(b.hem_name));
    } else if (sortType === "stock") {
        filteredProducts.sort((a, b) => b.qty - a.qty);
    } else if (sortType === "price") {
        filteredProducts.sort((a, b) => a.sell_price - b.sell_price);
    }
    
    currentPage = 1;
    renderProducts();
}

// Render products with pagination
function renderProducts() {
    const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageProducts = filteredProducts.slice(startIndex, endIndex);
    
    // Update pagination controls
    if (filteredProducts.length > itemsPerPage) {
        paginationControls.style.display = 'flex';
        currentPageDisplay.textContent = currentPage;
        pageInfo.textContent = `of ${totalPages} (${filteredProducts.length} items)`;
        
        firstPageBtn.disabled = currentPage === 1;
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages;
        lastPageBtn.disabled = currentPage === totalPages;
    } else {
        paginationControls.style.display = 'none';
    }
    
    // Render products
    if (pageProducts.length === 0) {
        productGrid.innerHTML = '<div class="loading">No products found.</div>';
        return;
    }
    
    productGrid.innerHTML = pageProducts.map(product => {
        let stockClass = "";
        let stockLabel = "";
        
        if (product.qty <= 60) {
            stockClass = "critical";
            stockLabel = "üî¥ Critical";
        } else if (product.qty <= 80) {
            stockClass = "low";
            stockLabel = "‚ö† Low";
        }
        
        return `
            <div class="card">
                <div class="img-placeholder">${product.image_url ? `<img src="${product.image_url}" style="max-width:100%; max-height:100%; object-fit:contain;">` : 'No Image'}</div>
                <div><strong>${product.hem_name}</strong></div>
                ${product.sup_part_no ? `<small style="color: #666;">SKU: ${product.sup_part_no}</small><br>` : ''}
                ${product.category ? `<small style="color: #888;">${product.category}</small>` : ''}
                <div class="stock ${stockClass}">Stock: ${product.qty} ${stockLabel}</div>
                <div style="margin-top: 5px; font-size: 14px; color: #4ade80;">SGD ${parseFloat(product.sell_price).toFixed(2)}</div>
                <div class="card-actions">
                    <button class="edit-btn" onclick="editProduct(${product.inventory_id})">Edit</button>
                    <button class="delete-btn" onclick="showDeleteModal(${product.inventory_id})">Delete</button>
                </div>
            </div>
        `;
    }).join("");
}

// Pagination controls
firstPageBtn.addEventListener('click', () => {
    currentPage = 1;
    renderProducts();
});

prevPageBtn.addEventListener('click', () => {
    if (currentPage > 1) {
        currentPage--;
        renderProducts();
    }
});

nextPageBtn.addEventListener('click', () => {
    const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
    if (currentPage < totalPages) {
        currentPage++;
        renderProducts();
    }
});

lastPageBtn.addEventListener('click', () => {
    const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
    currentPage = totalPages;
    renderProducts();
});

perPageSelect.addEventListener('change', (e) => {
    itemsPerPage = parseInt(e.target.value);
    currentPage = 1;
    renderProducts();
});

// Open modal for adding product
addProductBtn.addEventListener("click", () => {
    editingId = null;
    modalTitle.textContent = "Add Product";
    productForm.reset();
    clearValidationErrors();
    document.getElementById("productStock").value = "0";
    document.getElementById("productPrice").value = "0.00";
    document.getElementById("productCategory").value = "Lubricants";
    productModal.classList.add("active");
});

// Open modal for editing product
function editProduct(id) {
    editingId = id;
    const product = allProducts.find(p => p.inventory_id === id);
    
    modalTitle.textContent = "Edit Product";
    clearValidationErrors();
    document.getElementById("productPartNo").value = product.sup_part_no || '';
    document.getElementById("productName").value = product.hem_name;
    document.getElementById("productCategory").value = product.category || 'Lubricants';
    document.getElementById("productStock").value = product.qty;
    document.getElementById("productPrice").value = parseFloat(product.sell_price).toFixed(2);
    document.getElementById("productImage").value = product.image_url || '';
    
    productModal.classList.add("active");
}

// Show delete confirmation modal
function showDeleteModal(id) {
    deleteProductId = id;
    const product = allProducts.find(p => p.inventory_id === id);
    document.getElementById('deleteProductName').textContent = product.hem_name;
    deleteModal.classList.add('active');
}

// Cancel delete
cancelDeleteBtn.addEventListener('click', () => {
    deleteModal.classList.remove('active');
    deleteProductId = null;
});

// Confirm delete
confirmDeleteBtn.addEventListener('click', async () => {
    if (!deleteProductId) return;
    
    deleteModal.classList.remove('active');
    
    try {
        const response = await fetch(`/api/inventory/${deleteProductId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            await loadProducts();
            showBigNotification('PRODUCT DELETED!', false);
        } else {
            showBigNotification('FAILED TO DELETE: ' + result.message);
        }
    } catch (error) {
        console.error('Error deleting product:', error);
        showBigNotification('FAILED TO DELETE PRODUCT');
    }
    
    deleteProductId = null;
});

// Save product (Create or Update)
productForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    // Validate form
    if (!validateForm()) {
        showBigNotification('PLEASE FIX ERRORS');
        return;
    }
    
    const partNo = document.getElementById("productPartNo").value.trim();
    const name = document.getElementById("productName").value.trim();
    const category = document.getElementById("productCategory").value;
    const stock = parseInt(document.getElementById("productStock").value);
    const price = parseFloat(document.getElementById("productPrice").value);
    const imageUrl = document.getElementById("productImage").value.trim();
    
    const payload = {
        sup_part_no: partNo,
        hem_name: name,
        category: category,
        qty: stock,
        sell_price: price,
        image_url: imageUrl
    };
    
    // Disable save button during request
    const saveBtn = document.getElementById('saveBtn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';
    
    try {
        let response;
        
        if (editingId) {
            response = await fetch(`/api/inventory/${editingId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        } else {
            response = await fetch('/api/inventory', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        }
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            productModal.classList.remove("active");
            await loadProducts();
            showBigNotification(editingId ? 'PRODUCT UPDATED!' : 'PRODUCT SAVED!', true);
        } else {
            showBigNotification('FAILED TO SAVE: ' + result.message);
        }
    } catch (error) {
        console.error('Error saving product:', error);
        showBigNotification('FAILED TO SAVE PRODUCT');
    } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save';
    }
});

// Cancel button
cancelBtn.addEventListener("click", () => {
    productModal.classList.remove("active");
    clearValidationErrors();
});

// Close modal when clicking outside
productModal.addEventListener("click", (e) => {
    if (e.target === productModal) {
        productModal.classList.remove("active");
        clearValidationErrors();
    }
});

deleteModal.addEventListener("click", (e) => {
    if (e.target === deleteModal) {
        deleteModal.classList.remove("active");
        deleteProductId = null;
    }
});

// Real-time validation on input
document.getElementById('productName').addEventListener('input', () => {
    if (document.getElementById('productName').value.trim().length > 0) {
        validateField('productName', 'errorName', 
            val => val.trim().length >= 3, 
            'Product name must be at least 3 characters');
    }
});

document.getElementById('productStock').addEventListener('input', () => {
    validateField('productStock', 'errorStock', 
        val => !isNaN(val) && parseInt(val) >= 0, 
        'Stock must be 0 or greater');
});

document.getElementById('productPrice').addEventListener('input', () => {
    validateField('productPrice', 'errorPrice', 
        val => !isNaN(val) && parseFloat(val) >= 0.01, 
        'Price must be at least 0.01');
});

// Search and sort
searchInput.addEventListener("keyup", filterAndSortProducts);
sortSelect.addEventListener("change", filterAndSortProducts);

// Initial load
loadProducts();
</script>

{% endblock %}