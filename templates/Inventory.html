{% extends "base.html" %}

{% block title %}Inventory{% endblock %}

{% block content %}

<style>
body {
    font-family: Arial, sans-serif;
    background: #000;
    color: #fff;
    padding: 20px;
}

h1 {
    font-size: 28px;
    margin-bottom: 10px;
}

.controls {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.controls input, .controls select, .controls button {
    padding: 8px 12px;
    border-radius: 10px;
    border: 1px solid #333;
    background: #111;
    color: #fff;
}

.controls button {
    background: #0066ff;
    border: none;
    cursor: pointer;
    font-weight: bold;
}

.controls button:hover {
    background: #0052cc;
}

.grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
}

.card {
    background: #111;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #222;
    transition: 0.2s;
    position: relative;
}

.card:hover {
    background: #1f1f1f;
}

.img-placeholder {
    background: #1a1a1a;
    height: 150px;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #777;
    margin-bottom: 8px;
}

.stock {
    font-size: 13px;
    margin-top: 5px;
}

.low {
    color: orange;
}

.critical {
    color: red;
}

.card-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
}

.card-actions button {
    flex: 1;
    padding: 6px 10px;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    font-size: 12px;
}

.edit-btn {
    background: #28a745;
    color: white;
}

.edit-btn:hover {
    background: #218838;
}

.delete-btn {
    background: #dc3545;
    color: white;
}

.delete-btn:hover {
    background: #c82333;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: #1a1a1a;
    padding: 25px;
    border-radius: 15px;
    border: 1px solid #333;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-content h2 {
    margin-top: 0;
    margin-bottom: 20px;
}

.modal-content label {
    display: block;
    margin-bottom: 5px;
    font-size: 14px;
    color: #aaa;
}

.modal-content input, .modal-content select {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 8px;
    border: 1px solid #333;
    background: #111;
    color: #fff;
    box-sizing: border-box;
}

.modal-actions {
    display: flex;
    gap: 10px;
    margin-top: 20px;
}

.modal-actions button {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: bold;
}

.save-btn {
    background: #0066ff;
    color: white;
}

.save-btn:hover {
    background: #0052cc;
}

.cancel-btn {
    background: #555;
    color: white;
}

.cancel-btn:hover {
    background: #666;
}

.loading {
    text-align: center;
    padding: 50px;
    font-size: 18px;
    color: #777;
}

/* BIG ASS NOTIFICATION */
.big-notification {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    background: linear-gradient(135deg, #dc3545 0%, #ff6b6b 100%);
    color: white;
    padding: 50px 70px;
    border-radius: 25px;
    font-size: 48px;
    font-weight: 900;
    text-align: center;
    z-index: 10000;
    box-shadow: 0 20px 60px rgba(220, 53, 69, 0.5);
    border: 4px solid #fff;
    opacity: 0;
    pointer-events: none;
}

.big-notification.success {
    background: linear-gradient(135deg, #28a745 0%, #5cb85c 100%);
    box-shadow: 0 20px 60px rgba(40, 167, 69, 0.5);
}

.big-notification.show {
    animation: bigPopIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
}

.big-notification.hide {
    animation: bigPopOut 0.4s ease-in forwards;
}

@keyframes bigPopIn {
    0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 0;
    }
    50% {
        transform: translate(-50%, -50%) scale(1.1);
    }
    100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
    }
}

@keyframes bigPopOut {
    0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
    }
    100% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 0;
    }
}

.notification-icon {
    font-size: 80px;
    display: block;
    margin-bottom: 20px;
}
</style>

<div>
    <h1>Inventory Management</h1>
    
    <div class="controls">
        <input type="text" id="searchInput" placeholder="Search products...">
        <select id="sortSelect">
            <option value="">Sort by</option>
            <option value="name">Name (Aâ€“Z)</option>
            <option value="stock">Stock (High â†’ Low)</option>
        </select>
        <button id="addProductBtn">+ Add Product</button>
    </div>
    
    <div class="grid" id="productGrid">
        <div class="loading">Loading inventory...</div>
    </div>
</div>

<!-- Modal for Add/Edit Product -->
<div class="modal" id="productModal">
    <div class="modal-content">
        <h2 id="modalTitle">Add Product</h2>
        <form id="productForm">
            <label for="productPartNo">Supplier Part Number</label>
            <input type="text" id="productPartNo" placeholder="e.g., SP-12345">
            
            <label for="productName">Product Name *</label>
            <input type="text" id="productName" required>
            
            <label for="productCategory">Category</label>
            <select id="productCategory">
                <option value="Lubricants">Lubricants</option>
                <option value="Engine Oil">Engine Oil</option>
                <option value="Transmission Oil">Transmission Oil</option>
                <option value="Brake Fluid">Brake Fluid</option>
                <option value="Coolant">Coolant</option>
                <option value="Parts">Parts</option>
                <option value="Accessories">Accessories</option>
                <option value="Other">Other</option>
            </select>
            
            <label for="productStock">Stock Quantity *</label>
            <input type="number" id="productStock" required min="0" value="0">
            
            <label for="productPrice">Selling Price (SGD) *</label>
            <input type="number" id="productPrice" required min="0" step="0.01" value="0.00">
            
            <label for="productImage">Image URL (optional)</label>
            <input type="text" id="productImage" placeholder="https://...">
            
            <div class="modal-actions">
                <button type="submit" class="save-btn">Save</button>
                <button type="button" class="cancel-btn" id="cancelBtn">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- BIG ASS NOTIFICATION -->
<div id="bigNotification" class="big-notification"></div>

<script>
let products = [];
let editingId = null;

// Grab elements
const searchInput = document.getElementById("searchInput");
const sortSelect = document.getElementById("sortSelect");
const productGrid = document.getElementById("productGrid");
const addProductBtn = document.getElementById("addProductBtn");
const productModal = document.getElementById("productModal");
const productForm = document.getElementById("productForm");
const modalTitle = document.getElementById("modalTitle");
const cancelBtn = document.getElementById("cancelBtn");
const bigNotification = document.getElementById("bigNotification");

// Show BIG ASS notification
function showBigNotification(message, isSuccess = false) {
    const icon = isSuccess ? 'âœ“' : 'âœ–';
    bigNotification.innerHTML = `<span class="notification-icon">${icon}</span>${message}`;
    bigNotification.className = `big-notification ${isSuccess ? 'success' : ''}`;
    
    // Force reflow to restart animation
    void bigNotification.offsetWidth;
    
    bigNotification.classList.add('show');
    
    setTimeout(() => {
        bigNotification.classList.remove('show');
        bigNotification.classList.add('hide');
        setTimeout(() => {
            bigNotification.classList.remove('hide');
            bigNotification.className = 'big-notification';
        }, 400);
    }, 2500);
}

// Load products from database
async function loadProducts() {
    try {
        const response = await fetch('/api/inventory');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        products = data;
        renderProducts();
    } catch (error) {
        console.error('Error loading products:', error);
        productGrid.innerHTML = '<div class="loading" style="color: red;">Error loading inventory. Please refresh.</div>';
        showBigNotification('FAILED TO LOAD INVENTORY');
    }
}

// Render products
function renderProducts() {
    const searchText = searchInput.value.toLowerCase();
    const sortType = sortSelect.value;
    
    // Filter products
    let filteredProducts = products.filter(p => 
        p.hem_name.toLowerCase().includes(searchText) ||
        (p.sup_part_no && p.sup_part_no.toLowerCase().includes(searchText))
    );
    
    // Sort products
    if (sortType === "name") {
        filteredProducts.sort((a, b) => a.hem_name.localeCompare(b.hem_name));
    } else if (sortType === "stock") {
        filteredProducts.sort((a, b) => b.qty - a.qty);
    }
    
    // Render
    if (filteredProducts.length === 0) {
        productGrid.innerHTML = '<div class="loading">No products found.</div>';
        return;
    }
    
    productGrid.innerHTML = filteredProducts.map(product => {
        let stockClass = "";
        let stockLabel = "";
        
        if (product.qty <= 60) {
            stockClass = "critical";
            stockLabel = "ðŸ”´ Critical";
        } else if (product.qty <= 80) {
            stockClass = "low";
            stockLabel = "âš  Low";
        }
        
        return `
            <div class="card">
                <div class="img-placeholder">${product.image_url ? `<img src="${product.image_url}" style="max-width:100%; max-height:100%; object-fit:contain;">` : 'No Image'}</div>
                <div><strong>${product.hem_name}</strong></div>
                ${product.category ? `<small style="color: #888;">${product.category}</small>` : ''}
                <div class="stock ${stockClass}">Stock: ${product.qty} ${stockLabel}</div>
                <div style="margin-top: 5px; font-size: 14px; color: #4ade80;">SGD ${parseFloat(product.sell_price).toFixed(2)}</div>
                <div class="card-actions">
                    <button class="edit-btn" onclick="editProduct(${product.inventory_id})">Edit</button>
                    <button class="delete-btn" onclick="deleteProduct(${product.inventory_id})">Delete</button>
                </div>
            </div>
        `;
    }).join("");
}

// Open modal for adding product
addProductBtn.addEventListener("click", () => {
    editingId = null;
    modalTitle.textContent = "Add Product";
    productForm.reset();
    document.getElementById("productStock").value = "0";
    document.getElementById("productPrice").value = "0.00";
    productModal.classList.add("active");
});

// Open modal for editing product
function editProduct(id) {
    editingId = id;
    const product = products.find(p => p.inventory_id === id);
    
    modalTitle.textContent = "Edit Product";
    document.getElementById("productPartNo").value = product.sup_part_no || '';
    document.getElementById("productName").value = product.hem_name;
    document.getElementById("productCategory").value = product.category || 'Lubricants';
    document.getElementById("productStock").value = product.qty;
    document.getElementById("productPrice").value = parseFloat(product.sell_price).toFixed(2);
    document.getElementById("productImage").value = product.image_url || '';
    
    productModal.classList.add("active");
}

// Delete product
async function deleteProduct(id) {
    if (!confirm("Are you sure you want to delete this product?")) return;
    
    try {
        const response = await fetch(`/api/inventory/${id}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            await loadProducts();
            showBigNotification('PRODUCT DELETED!', false);
        } else {
            showBigNotification('FAILED TO DELETE: ' + result.message);
        }
    } catch (error) {
        console.error('Error deleting product:', error);
        showBigNotification('FAILED TO DELETE PRODUCT');
    }
}

// Save product (Create or Update)
productForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    const partNo = document.getElementById("productPartNo").value.trim();
    const name = document.getElementById("productName").value.trim();
    const category = document.getElementById("productCategory").value;
    const stock = parseInt(document.getElementById("productStock").value);
    const price = parseFloat(document.getElementById("productPrice").value);
    const imageUrl = document.getElementById("productImage").value.trim();
    
    const payload = {
        sup_part_no: partNo,
        hem_name: name,
        category: category,
        qty: stock,
        sell_price: price,
        image_url: imageUrl
    };
    
    try {
        let response;
        
        if (editingId) {
            // Update existing product
            response = await fetch(`/api/inventory/${editingId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        } else {
            // Create new product
            response = await fetch('/api/inventory', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        }
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
            productModal.classList.remove("active");
            await loadProducts();
            showBigNotification(editingId ? 'PRODUCT UPDATED!' : 'PRODUCT SAVED!', true);
        } else {
            showBigNotification('FAILED TO SAVE: ' + result.message);
        }
    } catch (error) {
        console.error('Error saving product:', error);
        showBigNotification('FAILED TO SAVE PRODUCT');
    }
});

// Cancel button
cancelBtn.addEventListener("click", () => {
    productModal.classList.remove("active");
});

// Close modal when clicking outside
productModal.addEventListener("click", (e) => {
    if (e.target === productModal) {
        productModal.classList.remove("active");
    }
});

// Search and sort
searchInput.addEventListener("keyup", renderProducts);
sortSelect.addEventListener("change", renderProducts);

// Initial load
loadProducts();
</script>

{% endblock %}